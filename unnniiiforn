using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace ApplicantTrackingSystem
{
    public class UniversityForm : Form
    {
        private int? universityId;
        private DatabaseHelper dbHelper;
        
        private TextBox txtUniversityName, txtCity, txtAddress, txtPhone, txtEmail, txtWebsite, txtDescription;
        private Button btnSave, btnCancel, btnDelete;

        public UniversityForm(int? id, DatabaseHelper dbHelper)
        {
            this.universityId = id;
            this.dbHelper = dbHelper;
            InitializeComponent();
            
            if (id.HasValue)
            {
                LoadUniversityData();
                this.Text = "Редактирование ВУЗа";
            }
            else
            {
                this.Text = "Новый ВУЗ";
            }
        }

        private void InitializeComponent()
        {
            this.Size = new Size(500, 500);
            this.StartPosition = FormStartPosition.CenterParent;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;
            this.Font = new Font("Segoe UI", 9);

            int y = 20;
            int labelWidth = 140;
            int controlWidth = 200;

            // Название ВУЗа
            Label lblUniversityName = new Label();
            lblUniversityName.Text = "Название ВУЗа:";
            lblUniversityName.Location = new Point(30, y);
            lblUniversityName.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblUniversityName);

            txtUniversityName = new TextBox();
            txtUniversityName.Location = new Point(180, y);
            txtUniversityName.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtUniversityName);
            y += 35;

            // Город
            Label lblCity = new Label();
            lblCity.Text = "Город:";
            lblCity.Location = new Point(30, y);
            lblCity.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblCity);

            txtCity = new TextBox();
            txtCity.Location = new Point(180, y);
            txtCity.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtCity);
            y += 35;

            // Адрес
            Label lblAddress = new Label();
            lblAddress.Text = "Адрес:";
            lblAddress.Location = new Point(30, y);
            lblAddress.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblAddress);

            txtAddress = new TextBox();
            txtAddress.Location = new Point(180, y);
            txtAddress.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtAddress);
            y += 35;

            // Телефон
            Label lblPhone = new Label();
            lblPhone.Text = "Телефон:";
            lblPhone.Location = new Point(30, y);
            lblPhone.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblPhone);

            txtPhone = new TextBox();
            txtPhone.Location = new Point(180, y);
            txtPhone.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtPhone);
            y += 35;

            // Email
            Label lblEmail = new Label();
            lblEmail.Text = "Email:";
            lblEmail.Location = new Point(30, y);
            lblEmail.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblEmail);

            txtEmail = new TextBox();
            txtEmail.Location = new Point(180, y);
            txtEmail.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtEmail);
            y += 35;

            // Веб-сайт
            Label lblWebsite = new Label();
            lblWebsite.Text = "Веб-сайт:";
            lblWebsite.Location = new Point(30, y);
            lblWebsite.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblWebsite);

            txtWebsite = new TextBox();
            txtWebsite.Location = new Point(180, y);
            txtWebsite.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtWebsite);
            y += 35;

            // Описание
            Label lblDescription = new Label();
            lblDescription.Text = "Описание:";
            lblDescription.Location = new Point(30, y);
            lblDescription.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblDescription);

            txtDescription = new TextBox();
            txtDescription.Location = new Point(180, y);
            txtDescription.Size = new Size(controlWidth, 80);
            txtDescription.Multiline = true;
            txtDescription.ScrollBars = ScrollBars.Vertical;
            this.Controls.Add(txtDescription);
            y += 90;

            // Кнопки
            Panel buttonPanel = new Panel();
            buttonPanel.Location = new Point(30, y);
            buttonPanel.Size = new Size(430, 50);

            btnSave = new Button();
            btnSave.Text = "Сохранить";
            btnSave.Location = new Point(50, 10);
            btnSave.Size = new Size(100, 35);
            btnSave.BackColor = Color.FromArgb(46, 204, 113);
            btnSave.ForeColor = Color.White;
            btnSave.Font = new Font("Segoe UI", 9, FontStyle.Bold);
            btnSave.Click += BtnSave_Click;
            buttonPanel.Controls.Add(btnSave);

            btnCancel = new Button();
            btnCancel.Text = "Отмена";
            btnCancel.Location = new Point(165, 10);
            btnCancel.Size = new Size(100, 35);
            btnCancel.BackColor = Color.FromArgb(149, 165, 166);
            btnCancel.ForeColor = Color.White;
            btnCancel.Font = new Font("Segoe UI", 9);
            btnCancel.Click += (s, e) => this.DialogResult = DialogResult.Cancel;
            buttonPanel.Controls.Add(btnCancel);

            if (universityId.HasValue)
            {
                btnDelete = new Button();
                btnDelete.Text = "Удалить";
                btnDelete.Location = new Point(280, 10);
                btnDelete.Size = new Size(100, 35);
                btnDelete.BackColor = Color.FromArgb(231, 76, 60);
                btnDelete.ForeColor = Color.White;
                btnDelete.Font = new Font("Segoe UI", 9, FontStyle.Bold);
                btnDelete.Click += BtnDelete_Click;
                buttonPanel.Controls.Add(btnDelete);
            }

            this.Controls.Add(buttonPanel);
        }

        private void LoadUniversityData()
        {
            try
            {
                string query = "SELECT * FROM universities WHERE UniversityID = @UniversityID";
                DataTable dt = dbHelper.ExecuteQuery(query, 
                    new MySqlParameter("@UniversityID", universityId.Value));
                
                if (dt.Rows.Count > 0)
                {
                    DataRow row = dt.Rows[0];
                    
                    txtUniversityName.Text = row["UniversityName"].ToString();
                    txtCity.Text = row["City"].ToString();
                    
                    if (row["Address"] != DBNull.Value)
                    {
                        txtAddress.Text = row["Address"].ToString();
                    }
                    
                    if (row["Phone"] != DBNull.Value)
                    {
                        txtPhone.Text = row["Phone"].ToString();
                    }
                    
                    if (row["Email"] != DBNull.Value)
                    {
                        txtEmail.Text = row["Email"].ToString();
                    }
                    
                    if (row["Website"] != DBNull.Value)
                    {
                        txtWebsite.Text = row["Website"].ToString();
                    }
                    
                    if (row["Description"] != DBNull.Value)
                    {
                        txtDescription.Text = row["Description"].ToString();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки данных ВУЗа: " + ex.Message, "Ошибка");
            }
        }

        private void BtnSave_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtUniversityName.Text))
            {
                MessageBox.Show("Введите название ВУЗа", "Ошибка");
                return;
            }

            try
            {
                if (universityId.HasValue)
                {
                    // Обновление существующего ВУЗа
                    string query = @"
                        UPDATE universities 
                        SET UniversityName = @UniversityName,
                            City = @City,
                            Address = @Address,
                            Phone = @Phone,
                            Email = @Email,
                            Website = @Website,
                            Description = @Description
                        WHERE UniversityID = @UniversityID";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@UniversityName", txtUniversityName.Text),
                        new MySqlParameter("@City", txtCity.Text),
                        new MySqlParameter("@Address", txtAddress.Text),
                        new MySqlParameter("@Phone", txtPhone.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Website", txtWebsite.Text),
                        new MySqlParameter("@Description", txtDescription.Text),
                        new MySqlParameter("@UniversityID", universityId.Value)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                else
                {
                    // Добавление нового ВУЗа
                    string query = @"
                        INSERT INTO universities (UniversityName, City, Address, Phone, Email, Website, Description)
                        VALUES (@UniversityName, @City, @Address, @Phone, @Email, @Website, @Description)";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@UniversityName", txtUniversityName.Text),
                        new MySqlParameter("@City", txtCity.Text),
                        new MySqlParameter("@Address", txtAddress.Text),
                        new MySqlParameter("@Phone", txtPhone.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Website", txtWebsite.Text),
                        new MySqlParameter("@Description", txtDescription.Text)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка сохранения ВУЗа: " + ex.Message, "Ошибка");
            }
        }

        private void BtnDelete_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Вы уверены, что хотите удалить этот ВУЗ?", 
                "Подтверждение удаления", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
            {
                try
                {
                    // Проверяем, есть ли заявки на этот ВУЗ
                    string checkQuery = "SELECT COUNT(*) FROM applications WHERE UniversityID = @UniversityID";
                    int applicationsCount = Convert.ToInt32(dbHelper.ExecuteScalar(checkQuery, 
                        new MySqlParameter("@UniversityID", universityId.Value)));
                    
                    if (applicationsCount > 0)
                    {
                        MessageBox.Show("Невозможно удалить ВУЗ, на который есть заявки.\n" +
                                      "Сначала удалите все связанные заявки.", 
                                      "Ошибка", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                    
                    string query = "DELETE FROM universities WHERE UniversityID = @UniversityID";
                    dbHelper.ExecuteNonQuery(query, new MySqlParameter("@UniversityID", universityId.Value));
                    
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Ошибка удаления ВУЗа: " + ex.Message, "Ошибка");
                }
            }
        }
    }
}