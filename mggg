using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace AutoSalonApp
{
    public partial class MainForm : Form
    {
        private DatabaseHelper dbHelper;
        private TabControl tabControl1;
        
        private TabPage tabBrands, tabCars, tabEmployees, tabCustomers, tabSales, tabStatistics, tabUsers;
        private DataGridView dataGridViewBrands, dataGridViewCars, dataGridViewEmployees, 
                          dataGridViewCustomers, dataGridViewSales, dataGridViewStats;
        
        private ComboBox cmbBrands, cmbCar, cmbCustomer, cmbEmployee;
        private TextBox txtBrandName, txtCountry, txtModel, txtColor, txtVIN, txtSearchCar;
        private NumericUpDown numYear, numPrice, numSalePrice;
        private DateTimePicker dtpSaleDate;
        private Button btnAddBrand, btnAddCar, btnAddSale, btnSearchCars, btnRefresh, btnLogout;
        
        private string currentUsername, currentRole, currentFullName;
        private Label lblStatsTotalCars, lblStatsAvailableCars, lblStatsTotalSales, lblStatsTotalRevenue;

        public MainForm(string username, string role, string fullName)
        {
            currentUsername = username;
            currentRole = role;
            currentFullName = fullName;
            
            InitializeComponent();
            SetupPermissions();
            LoadInitialData();
        }

        private void InitializeComponent()
        {
            this.Text = $"Автосалон - {currentFullName} ({currentRole})";
            this.Size = new Size(1200, 700);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Font = new Font("Segoe UI", 9);
            
            CreateHeader();
            CreateTabs();
            CreateRefreshButton();
            
            this.Controls.Add(tabControl1);
            this.Controls.Add(btnRefresh);
        }

        private void CreateHeader()
        {
            Panel header = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1150, 40),
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.FromArgb(240, 240, 240)
            };

            Label lblInfo = new Label
            {
                Text = $"Пользователь: {currentFullName} | Роль: {currentRole} | Время входа: {DateTime.Now:HH:mm:ss}",
                Location = new Point(10, 10),
                Size = new Size(800, 20),
                Font = new Font("Segoe UI", 10, FontStyle.Bold),
                ForeColor = Color.FromArgb(52, 152, 219)
            };

            btnLogout = new Button
            {
                Text = "Выйти",
                Location = new Point(1050, 5),
                Size = new Size(90, 30),
                BackColor = Color.FromArgb(231, 76, 60),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnLogout.Click += BtnLogout_Click;

            header.Controls.Add(lblInfo);
            header.Controls.Add(btnLogout);
            this.Controls.Add(header);
        }

        private void CreateTabs()
        {
            tabControl1 = new TabControl
            {
                Location = new Point(15, 60),
                Size = new Size(1150, 580),
                Font = new Font("Segoe UI", 9)
            };

            // Создаем только основные вкладки
            tabBrands = CreateBrandsTab();
            tabCars = CreateCarsTab();
            tabSales = CreateSalesTab();
            tabStatistics = CreateStatisticsTab();

            tabControl1.TabPages.AddRange(new TabPage[] { tabBrands, tabCars, tabSales, tabStatistics });

            // Добавляем дополнительные вкладки в зависимости от роли
            if (currentRole == "Администратор" || currentRole == "Менеджер")
            {
                tabEmployees = CreateSimpleTab("Сотрудники", out dataGridViewEmployees);
                tabCustomers = CreateSimpleTab("Покупатели", out dataGridViewCustomers);
                tabControl1.TabPages.Add(tabEmployees);
                tabControl1.TabPages.Add(tabCustomers);
                
                if (currentRole == "Администратор")
                {
                    tabUsers = CreateUsersTab();
                    tabControl1.TabPages.Add(tabUsers);
                }
            }
        }

        private TabPage CreateBrandsTab()
        {
            var tab = new TabPage("Марки");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 60),
                BorderStyle = BorderStyle.FixedSingle
            };

            txtBrandName = new TextBox { Location = new Point(115, 17), Size = new Size(100, 23) };
            txtCountry = new TextBox { Location = new Point(275, 17), Size = new Size(100, 23) };
            
            btnAddBrand = new Button
            {
                Location = new Point(390, 15),
                Size = new Size(100, 27),
                Text = "Добавить марку"
            };
            btnAddBrand.Click += BtnAddBrand_Click;

            inputPanel.Controls.Add(new Label { Text = "Название:", Location = new Point(10, 20), Size = new Size(100, 20) });
            inputPanel.Controls.Add(new Label { Text = "Страна:", Location = new Point(220, 20), Size = new Size(50, 20) });
            inputPanel.Controls.Add(txtBrandName);
            inputPanel.Controls.Add(txtCountry);
            inputPanel.Controls.Add(btnAddBrand);

            dataGridViewBrands = new DataGridView
            {
                Location = new Point(10, 80),
                Size = new Size(1110, 470),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewBrands);
            return tab;
        }

        private TabPage CreateCarsTab()
        {
            var tab = new TabPage("Автомобили");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 80),
                BorderStyle = BorderStyle.FixedSingle
            };

            // Основные элементы
            cmbBrands = new ComboBox
            {
                Location = new Point(60, 12),
                Size = new Size(110, 23),
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            txtModel = new TextBox { Location = new Point(60, 42), Size = new Size(110, 23) };
            numYear = new NumericUpDown { Location = new Point(220, 12), Size = new Size(60, 23), Minimum = 2000, Maximum = 2030, Value = 2024 };
            txtColor = new TextBox { Location = new Point(220, 42), Size = new Size(110, 23) };
            numPrice = new NumericUpDown { Location = new Point(395, 12), Size = new Size(90, 23), Minimum = 0, Maximum = 100000000, Value = 1000000 };
            txtVIN = new TextBox { Location = new Point(395, 42), Size = new Size(120, 23) };
            
            btnAddCar = new Button
            {
                Location = new Point(530, 15),
                Size = new Size(100, 50),
                Text = "Добавить авто"
            };
            btnAddCar.Click += BtnAddCar_Click;

            // Поиск
            txtSearchCar = new TextBox { Location = new Point(60, 14), Size = new Size(200, 23) };
            btnSearchCars = new Button
            {
                Location = new Point(270, 14),
                Size = new Size(80, 25),
                Text = "Найти"
            };
            btnSearchCars.Click += BtnSearchCars_Click;

            var searchPanel = new Panel { Location = new Point(650, 15), Size = new Size(400, 50) };
            searchPanel.Controls.Add(new Label { Text = "Поиск:", Location = new Point(5, 17), Size = new Size(50, 20) });
            searchPanel.Controls.Add(txtSearchCar);
            searchPanel.Controls.Add(btnSearchCars);

            // Добавление всех элементов
            inputPanel.Controls.AddRange(new Control[] {
                new Label { Text = "Марка:", Location = new Point(10, 15), Size = new Size(45, 20) },
                new Label { Text = "Модель:", Location = new Point(10, 45), Size = new Size(45, 20) },
                new Label { Text = "Год:", Location = new Point(180, 15), Size = new Size(35, 20) },
                new Label { Text = "Цвет:", Location = new Point(180, 45), Size = new Size(40, 20) },
                new Label { Text = "Цена:", Location = new Point(350, 15), Size = new Size(40, 20) },
                new Label { Text = "VIN:", Location = new Point(350, 45), Size = new Size(35, 20) },
                cmbBrands, txtModel, numYear, txtColor, numPrice, txtVIN, btnAddCar
            });
            inputPanel.Controls.Add(searchPanel);

            dataGridViewCars = new DataGridView
            {
                Location = new Point(10, 100),
                Size = new Size(1110, 450),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewCars);
            return tab;
        }

        private TabPage CreateSalesTab()
        {
            var tab = new TabPage("Продажи");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 80),
                BorderStyle = BorderStyle.FixedSingle
            };

            cmbCar = new ComboBox { Location = new Point(85, 12), Size = new Size(150, 23), DropDownStyle = ComboBoxStyle.DropDownList };
            cmbCustomer = new ComboBox { Location = new Point(85, 42), Size = new Size(150, 23), DropDownStyle = ComboBoxStyle.DropDownList };
            cmbEmployee = new ComboBox { Location = new Point(325, 12), Size = new Size(150, 23), DropDownStyle = ComboBoxStyle.DropDownList };
            dtpSaleDate = new DateTimePicker { Location = new Point(335, 42), Size = new Size(120, 23), Value = DateTime.Now };
            numSalePrice = new NumericUpDown { Location = new Point(575, 12), Size = new Size(100, 23), Minimum = 0, Maximum = 100000000, Value = 1000000 };
            
            btnAddSale = new Button
            {
                Location = new Point(690, 15),
                Size = new Size(120, 40),
                Text = "Оформить продажу",
                BackColor = Color.FromArgb(46, 204, 113),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnAddSale.Click += BtnAddSale_Click;

            inputPanel.Controls.AddRange(new Control[] {
                new Label { Text = "Автомобиль:", Location = new Point(10, 15), Size = new Size(70, 20) },
                new Label { Text = "Покупатель:", Location = new Point(10, 45), Size = new Size(70, 20) },
                new Label { Text = "Сотрудник:", Location = new Point(250, 15), Size = new Size(70, 20) },
                new Label { Text = "Дата продажи:", Location = new Point(250, 45), Size = new Size(80, 20) },
                new Label { Text = "Цена продажи:", Location = new Point(490, 15), Size = new Size(80, 20) },
                cmbCar, cmbCustomer, cmbEmployee, dtpSaleDate, numSalePrice, btnAddSale
            });

            dataGridViewSales = new DataGridView
            {
                Location = new Point(10, 100),
                Size = new Size(1110, 450),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewSales);
            return tab;
        }

        private TabPage CreateStatisticsTab()
        {
            var tab = new TabPage("Статистика");
            
            Panel statsPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 150),
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.FromArgb(240, 240, 240)
            };

            lblStatsTotalCars = new Label { Text = "0", Location = new Point(180, 50), Size = new Size(100, 25), ForeColor = Color.Blue };
            lblStatsAvailableCars = new Label { Text = "0", Location = new Point(180, 80), Size = new Size(100, 25), ForeColor = Color.Green };
            lblStatsTotalSales = new Label { Text = "0", Location = new Point(510, 50), Size = new Size(100, 25), ForeColor = Color.Orange };
            lblStatsTotalRevenue = new Label { Text = "0 руб.", Location = new Point(510, 80), Size = new Size(200, 25), ForeColor = Color.Red };

            statsPanel.Controls.AddRange(new Control[] {
                new Label { Text = "Статистика автосалона", Font = new Font("Segoe UI", 14, FontStyle.Bold), 
                          Location = new Point(10, 10), Size = new Size(400, 30), ForeColor = Color.FromArgb(52, 73, 94) },
                new Label { Text = "Всего автомобилей:", Location = new Point(20, 50), Size = new Size(150, 25), Font = new Font("Segoe UI", 10, FontStyle.Bold) },
                new Label { Text = "Авто в наличии:", Location = new Point(20, 80), Size = new Size(150, 25), Font = new Font("Segoe UI", 10, FontStyle.Bold) },
                new Label { Text = "Всего продаж:", Location = new Point(350, 50), Size = new Size(150, 25), Font = new Font("Segoe UI", 10, FontStyle.Bold) },
                new Label { Text = "Общая выручка:", Location = new Point(350, 80), Size = new Size(150, 25), Font = new Font("Segoe UI", 10, FontStyle.Bold) },
                lblStatsTotalCars, lblStatsAvailableCars, lblStatsTotalSales, lblStatsTotalRevenue
            });

            dataGridViewStats = new DataGridView
            {
                Location = new Point(10, 170),
                Size = new Size(1110, 380),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                ReadOnly = true
            };

            tab.Controls.Add(statsPanel);
            tab.Controls.Add(dataGridViewStats);
            return tab;
        }

        private TabPage CreateSimpleTab(string title, out DataGridView dataGridView)
        {
            var tab = new TabPage(title);
            
            dataGridView = new DataGridView
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 540),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(dataGridView);
            return tab;
        }

        private TabPage CreateUsersTab()
        {
            var tab = new TabPage("Пользователи");
            
            dataGridViewCustomers = new DataGridView // Используем существующую переменную
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 540),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect,
                ReadOnly = true
            };

            tab.Controls.Add(dataGridViewCustomers);
            return tab;
        }

        private void CreateRefreshButton()
        {
            btnRefresh = new Button
            {
                Text = "Обновить все",
                Location = new Point(15, 650),
                Size = new Size(100, 35),
                BackColor = Color.FromArgb(241, 196, 15),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnRefresh.Click += BtnRefresh_Click;
        }

        private void SetupPermissions()
        {
            // Упрощенная проверка прав доступа
            if (currentRole == "Консультант")
            {
                // Для консультанта оставляем только автомобили и продажи
                tabControl1.TabPages.Clear();
                tabControl1.TabPages.AddRange(new TabPage[] { tabCars, tabSales });
            }
        }

        private void LoadInitialData()
        {
            try
            {
                dbHelper = new DatabaseHelper();
                LoadComboBoxData();
                RefreshAllData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка инициализации: " + ex.Message, "Ошибка");
            }
        }

        private void LoadComboBoxData()
        {
            try
            {
                // Загрузка марок
                DataTable brands = dbHelper.ExecuteQuery("SELECT BrandID, BrandName FROM Brands ORDER BY BrandName");
                cmbBrands.DataSource = brands;
                cmbBrands.DisplayMember = "BrandName";
                cmbBrands.ValueMember = "BrandID";

                // Загрузка доступных автомобилей
                DataTable cars = dbHelper.ExecuteQuery(@"
                    SELECT CarID, CONCAT(b.BrandName, ' ', c.Model) as CarInfo 
                    FROM Cars c 
                    JOIN Brands b ON c.BrandID = b.BrandID 
                    WHERE c.InStock = TRUE
                    ORDER BY b.BrandName, c.Model");
                cmbCar.DataSource = cars;
                cmbCar.DisplayMember = "CarInfo";
                cmbCar.ValueMember = "CarID";

                // Загрузка покупателей
                DataTable customers = dbHelper.ExecuteQuery(
                    "SELECT CustomerID, CONCAT(FirstName, ' ', LastName) as FullName FROM Customers ORDER BY LastName, FirstName");
                cmbCustomer.DataSource = customers;
                cmbCustomer.DisplayMember = "FullName";
                cmbCustomer.ValueMember = "CustomerID";

                // Загрузка сотрудников
                DataTable employees = dbHelper.ExecuteQuery(
                    "SELECT EmployeeID, CONCAT(FirstName, ' ', LastName) as FullName FROM Employees ORDER BY LastName, FirstName");
                cmbEmployee.DataSource = employees;
                cmbEmployee.DisplayMember = "FullName";
                cmbEmployee.ValueMember = "EmployeeID";
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки данных: " + ex.Message, "Ошибка");
            }
        }

        private void RefreshAllData()
        {
            try
            {
                LoadBrands();
                LoadCars();
                LoadSales();
                UpdateStatistics();
                LoadSalesStatistics();
                
                if (currentRole == "Администратор" || currentRole == "Менеджер")
                {
                    LoadEmployees();
                    LoadCustomers();
                    if (currentRole == "Администратор") LoadUsers();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка обновления данных: " + ex.Message, "Ошибка");
            }
        }

        private void LoadBrands()
        {
            string query = "SELECT * FROM Brands ORDER BY BrandName";
            dataGridViewBrands.DataSource = dbHelper.ExecuteQuery(query);
        }

        private void LoadCars()
        {
            string query = @"
                SELECT 
                    c.CarID as 'ID',
                    b.BrandName as 'Марка',
                    c.Model as 'Модель',
                    c.Year as 'Год',
                    c.Color as 'Цвет', 
                    FORMAT(c.Price, 0) as 'Цена',
                    c.VIN as 'VIN-код',
                    CASE WHEN c.InStock THEN 'В наличии' ELSE 'Продано' END as 'Статус'
                FROM Cars c 
                JOIN Brands b ON c.BrandID = b.BrandID
                ORDER BY b.BrandName, c.Model";
            dataGridViewCars.DataSource = dbHelper.ExecuteQuery(query);
        }

        private void LoadEmployees()
        {
            if (dataGridViewEmployees != null)
            {
                string query = @"
                    SELECT 
                        EmployeeID as 'ID',
                        FirstName as 'Имя',
                        LastName as 'Фамилия',
                        Position as 'Должность',
                        Phone as 'Телефон',
                        DATE_FORMAT(HireDate, '%d.%m.%Y') as 'Дата найма'
                    FROM Employees 
                    ORDER BY LastName, FirstName";
                dataGridViewEmployees.DataSource = dbHelper.ExecuteQuery(query);
            }
        }

        private void LoadCustomers()
        {
            if (dataGridViewCustomers != null)
            {
                string query = @"
                    SELECT 
                        CustomerID as 'ID',
                        FirstName as 'Имя',
                        LastName as 'Фамилия',
                        Email as 'Email',
                        Phone as 'Телефон',
                        Address as 'Адрес'
                    FROM Customers 
                    ORDER BY LastName, FirstName";
                dataGridViewCustomers.DataSource = dbHelper.ExecuteQuery(query);
            }
        }

        private void LoadSales()
        {
            string query = @"
                SELECT 
                    s.SaleID as 'ID',
                    b.BrandName as 'Марка',
                    c.Model as 'Модель',
                    CONCAT(cust.FirstName, ' ', cust.LastName) as 'Покупатель',
                    CONCAT(emp.FirstName, ' ', emp.LastName) as 'Сотрудник',
                    DATE_FORMAT(s.SaleDate, '%d.%m.%Y') as 'Дата продажи',
                    FORMAT(s.SalePrice, 0) as 'Сумма продажи'
                FROM Sales s
                JOIN Cars c ON s.CarID = c.CarID
                JOIN Brands b ON c.BrandID = b.BrandID
                JOIN Customers cust ON s.CustomerID = cust.CustomerID
                JOIN Employees emp ON s.EmployeeID = emp.EmployeeID
                ORDER BY s.SaleDate DESC";
            dataGridViewSales.DataSource = dbHelper.ExecuteQuery(query);
        }

        private void LoadUsers()
        {
            if (dataGridViewCustomers != null) // Используем dataGridViewCustomers для пользователей
            {
                string query = @"
                    SELECT 
                        id as 'ID',
                        username as 'Логин',
                        full_name as 'ФИО',
                        email as 'Email',
                        role as 'Роль',
                        DATE_FORMAT(created_at, '%d.%m.%Y %H:%i') as 'Дата регистрации',
                        CASE WHEN is_active THEN 'Активен' ELSE 'Не активен' END as 'Статус'
                    FROM users
                    ORDER BY role, username";
                dataGridViewCustomers.DataSource = dbHelper.ExecuteQuery(query);
            }
        }

        private void UpdateStatistics()
        {
            try
            {
                // Общее количество автомобилей
                DataTable totalCarsDt = dbHelper.ExecuteQuery("SELECT COUNT(*) FROM Cars");
                lblStatsTotalCars.Text = totalCarsDt.Rows[0][0].ToString();

                // Автомобили в наличии
                DataTable availableCarsDt = dbHelper.ExecuteQuery("SELECT COUNT(*) FROM Cars WHERE InStock = TRUE");
                lblStatsAvailableCars.Text = availableCarsDt.Rows[0][0].ToString();

                // Общее количество продаж
                DataTable totalSalesDt = dbHelper.ExecuteQuery("SELECT COUNT(*) FROM Sales");
                lblStatsTotalSales.Text = totalSalesDt.Rows[0][0].ToString();

                // Общая выручка
                DataTable totalRevenueDt = dbHelper.ExecuteQuery("SELECT SUM(SalePrice) FROM Sales");
                if (totalRevenueDt.Rows[0][0] != DBNull.Value)
                {
                    decimal revenue = Convert.ToDecimal(totalRevenueDt.Rows[0][0]);
                    lblStatsTotalRevenue.Text = $"{revenue:N0} руб.";
                }
            }
            catch { /* Игнорируем ошибки статистики */ }
        }

        private void LoadSalesStatistics()
        {
            string query = @"
                SELECT 
                    DATE_FORMAT(SaleDate, '%Y-%m') as 'Месяц',
                    COUNT(*) as 'Количество продаж',
                    SUM(SalePrice) as 'Общая сумма',
                    AVG(SalePrice) as 'Средний чек'
                FROM Sales
                GROUP BY DATE_FORMAT(SaleDate, '%Y-%m')
                ORDER BY DATE_FORMAT(SaleDate, '%Y-%m') DESC
                LIMIT 12";
            dataGridViewStats.DataSource = dbHelper.ExecuteQuery(query);
        }

        // ===== ОБРАБОТЧИКИ СОБЫТИЙ =====

        private void BtnLogout_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Вы уверены, что хотите выйти?", "Подтверждение", 
                MessageBoxButtons.YesNo) == DialogResult.Yes)
            {
                this.Close();
            }
        }

        private void BtnAddBrand_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtBrandName.Text))
            {
                MessageBox.Show("Введите название марки", "Ошибка");
                return;
            }

            try
            {
                string query = "INSERT INTO Brands (BrandName, Country) VALUES (@BrandName, @Country)";
                dbHelper.ExecuteNonQuery(query,
                    new MySqlParameter("@BrandName", txtBrandName.Text),
                    new MySqlParameter("@Country", txtCountry.Text));
                
                MessageBox.Show("Марка добавлена", "Успех");
                txtBrandName.Text = "";
                txtCountry.Text = "";
                LoadBrands();
                LoadComboBoxData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message, "Ошибка");
            }
        }

        private void BtnAddCar_Click(object sender, EventArgs e)
        {
            if (cmbBrands.SelectedIndex == -1 || string.IsNullOrWhiteSpace(txtModel.Text))
            {
                MessageBox.Show("Заполните обязательные поля", "Ошибка");
                return;
            }

            try
            {
                string query = @"
                    INSERT INTO Cars (BrandID, Model, Year, Color, Price, VIN, InStock)
                    VALUES (@BrandID, @Model, @Year, @Color, @Price, @VIN, TRUE)";
                
                dbHelper.ExecuteNonQuery(query,
                    new MySqlParameter("@BrandID", cmbBrands.SelectedValue),
                    new MySqlParameter("@Model", txtModel.Text),
                    new MySqlParameter("@Year", (int)numYear.Value),
                    new MySqlParameter("@Color", txtColor.Text),
                    new MySqlParameter("@Price", numPrice.Value),
                    new MySqlParameter("@VIN", txtVIN.Text));
                
                MessageBox.Show("Автомобиль добавлен", "Успех");
                txtModel.Text = txtColor.Text = txtVIN.Text = "";
                numPrice.Value = 1000000;
                LoadCars();
                LoadComboBoxData();
                UpdateStatistics();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message, "Ошибка");
            }
        }

        private void BtnAddSale_Click(object sender, EventArgs e)
        {
            if (cmbCar.SelectedIndex == -1 || cmbCustomer.SelectedIndex == -1 || cmbEmployee.SelectedIndex == -1)
            {
                MessageBox.Show("Заполните все поля", "Ошибка");
                return;
            }

            try
            {
                // Используем транзакцию
                dbHelper.ExecuteNonQuery("START TRANSACTION");
                
                // Добавляем продажу
                string saleQuery = @"
                    INSERT INTO Sales (CarID, CustomerID, EmployeeID, SaleDate, SalePrice)
                    VALUES (@CarID, @CustomerID, @EmployeeID, @SaleDate, @SalePrice)";
                
                dbHelper.ExecuteNonQuery(saleQuery,
                    new MySqlParameter("@CarID", cmbCar.SelectedValue),
                    new MySqlParameter("@CustomerID", cmbCustomer.SelectedValue),
                    new MySqlParameter("@EmployeeID", cmbEmployee.SelectedValue),
                    new MySqlParameter("@SaleDate", dtpSaleDate.Value),
                    new MySqlParameter("@SalePrice", numSalePrice.Value));
                
                // Помечаем автомобиль как проданный
                dbHelper.ExecuteNonQuery("UPDATE Cars SET InStock = FALSE WHERE CarID = @CarID",
                    new MySqlParameter("@CarID", cmbCar.SelectedValue));
                
                dbHelper.ExecuteNonQuery("COMMIT");
                
                MessageBox.Show("Продажа оформлена", "Успех");
                LoadCars();
                LoadSales();
                LoadComboBoxData();
                UpdateStatistics();
                LoadSalesStatistics();
            }
            catch (Exception ex)
            {
                dbHelper.ExecuteNonQuery("ROLLBACK");
                MessageBox.Show("Ошибка: " + ex.Message, "Ошибка");
            }
        }

        private void BtnSearchCars_Click(object sender, EventArgs e)
        {
            string searchText = txtSearchCar.Text.Trim();
            if (string.IsNullOrWhiteSpace(searchText))
            {
                LoadCars();
                return;
            }

            try
            {
                string query = @"
                    SELECT 
                        c.CarID as 'ID',
                        b.BrandName as 'Марка',
                        c.Model as 'Модель',
                        c.Year as 'Год',
                        c.Color as 'Цвет', 
                        FORMAT(c.Price, 0) as 'Цена',
                        c.VIN as 'VIN-код',
                        CASE WHEN c.InStock THEN 'В наличии' ELSE 'Продано' END as 'Статус'
                    FROM Cars c 
                    JOIN Brands b ON c.BrandID = b.BrandID
                    WHERE b.BrandName LIKE @Search OR 
                          c.Model LIKE @Search OR 
                          c.Color LIKE @Search OR
                          c.VIN LIKE @Search
                    ORDER BY b.BrandName, c.Model";
                
                dataGridViewCars.DataSource = dbHelper.ExecuteQuery(query,
                    new MySqlParameter("@Search", $"%{searchText}%"));
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка поиска: " + ex.Message, "Ошибка");
            }
        }

        private void BtnRefresh_Click(object sender, EventArgs e)
        {
            RefreshAllData();
            MessageBox.Show("Данные обновлены", "Информация");
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            base.OnFormClosing(e);
            if (e.CloseReason == CloseReason.UserClosing)
            {
                if (MessageBox.Show("Закрыть приложение?", "Подтверждение", 
                    MessageBoxButtons.YesNo) == DialogResult.No)
                {
                    e.Cancel = true;
                }
            }
        }
    }
}