using System;
using System.Windows.Forms;

namespace Kursovaya
{
    internal static class Program
    {
        /// <summary>
        /// Главная точка входа для приложения.
        /// </summary>
        [STAThread]
        static void Main()
        {
            Application.EnableVisualStyles();
            Application.SetCompatibleTextRenderingDefault(false);

            // Проверка подключения к БД перед запуском
            try
            {
                // Используем using для правильного освобождения ресурсов
                using (var dbHelper = new DatabaseHelper())
                {
                    if (!dbHelper.TestConnection())
                    {
                        MessageBox.Show(
                            "Не удалось подключиться к базе данных!\n\n" +
                            "Убедитесь, что:\n" +
                            "1. MySQL сервер запущен\n" +
                            "2. База данных 'applicant_tracking' создана\n" +
                            "3. Данные для подключения верны\n\n" +
                            "Проверьте файл App.config",
                            "Ошибка подключения",
                            MessageBoxButtons.OK,
                            MessageBoxIcon.Error
                        );
                        return;
                    }
                }

                // Используем цикл для повторного входа при неудаче
                bool loginSuccessful = false;
                
                while (!loginSuccessful)
                {
                    using (LoginForm loginForm = new LoginForm())
                    {
                        // Показываем форму входа как диалоговое окно
                        DialogResult result = loginForm.ShowDialog();
                        
                        if (result == DialogResult.OK)
                        {
                            // Успешный вход, запускаем главную форму
                            loginSuccessful = true;
                            
                            // Создаем главную форму с данными пользователя
                            using (MainForm mainForm = new MainForm(
                                loginForm.CurrentUsername,
                                loginForm.CurrentRole,
                                loginForm.CurrentFullName))
                            {
                                Application.Run(mainForm);
                            }
                            
                            // Если пользователь вышел из главной формы, 
                            // можно предложить снова войти
                            // Для этого loginSuccessful снова станет false
                            // и цикл повторится
                            loginSuccessful = false; // Раскомментировать если нужно разрешить повторный вход
                        }
                        else if (result == DialogResult.Cancel || result == DialogResult.Abort)
                        {
                            // Выход из приложения
                            return;
                        }
                        // Если результат не OK и не Cancel, цикл продолжается
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"Критическая ошибка при запуске:\n{ex.Message}\n\nStackTrace:\n{ex.StackTrace}",
                    "Ошибка",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error
                );
            }
        }
    }
}