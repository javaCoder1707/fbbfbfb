using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace AutoSalonApp
{
    public class EmployeeForm : Form
    {
        private int? employeeId;
        private DatabaseHelper dbHelper;
        
        private TextBox txtFirstName;
        private TextBox txtLastName;
        private TextBox txtPosition;
        private TextBox txtPhone;
        private TextBox txtEmail;
        private TextBox txtAddress;
        private DateTimePicker dtpHireDate;
        private NumericUpDown numSalary;
        private ComboBox cmbDepartment;
        private DateTimePicker dtpBirthDate;
        
        private Button btnSave;
        private Button btnCancel;
        private Button btnDelete;

        public EmployeeForm(int? id, DatabaseHelper dbHelper)
        {
            this.employeeId = id;
            this.dbHelper = dbHelper;
            InitializeComponent();
            
            LoadDepartments();
            if (id.HasValue)
            {
                LoadEmployeeData();
                this.Text = "Редактирование сотрудника";
            }
            else
            {
                this.Text = "Новый сотрудник";
            }
        }

        private void InitializeComponent()
        {
            this.Size = new Size(500, 550);
            this.StartPosition = FormStartPosition.CenterParent;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;

            int y = 20;
            int labelWidth = 120;
            int controlWidth = 200;

            // Имя
            Label lblFirstName = new Label();
            lblFirstName.Text = "Имя:";
            lblFirstName.Location = new Point(30, y);
            lblFirstName.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblFirstName);

            txtFirstName = new TextBox();
            txtFirstName.Location = new Point(160, y);
            txtFirstName.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtFirstName);
            y += 35;

            // Фамилия
            Label lblLastName = new Label();
            lblLastName.Text = "Фамилия:";
            lblLastName.Location = new Point(30, y);
            lblLastName.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblLastName);

            txtLastName = new TextBox();
            txtLastName.Location = new Point(160, y);
            txtLastName.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtLastName);
            y += 35;

            // Должность
            Label lblPosition = new Label();
            lblPosition.Text = "Должность:";
            lblPosition.Location = new Point(30, y);
            lblPosition.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblPosition);

            txtPosition = new TextBox();
            txtPosition.Location = new Point(160, y);
            txtPosition.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtPosition);
            y += 35;

            // Отдел
            Label lblDepartment = new Label();
            lblDepartment.Text = "Отдел:";
            lblDepartment.Location = new Point(30, y);
            lblDepartment.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblDepartment);

            cmbDepartment = new ComboBox();
            cmbDepartment.Location = new Point(160, y);
            cmbDepartment.Size = new Size(controlWidth, 23);
            cmbDepartment.DropDownStyle = ComboBoxStyle.DropDownList;
            this.Controls.Add(cmbDepartment);
            y += 35;

            // Телефон
            Label lblPhone = new Label();
            lblPhone.Text = "Телефон:";
            lblPhone.Location = new Point(30, y);
            lblPhone.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblPhone);

            txtPhone = new TextBox();
            txtPhone.Location = new Point(160, y);
            txtPhone.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtPhone);
            y += 35;

            // Email
            Label lblEmail = new Label();
            lblEmail.Text = "Email:";
            lblEmail.Location = new Point(30, y);
            lblEmail.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblEmail);

            txtEmail = new TextBox();
            txtEmail.Location = new Point(160, y);
            txtEmail.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtEmail);
            y += 35;

            // Адрес
            Label lblAddress = new Label();
            lblAddress.Text = "Адрес:";
            lblAddress.Location = new Point(30, y);
            lblAddress.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblAddress);

            txtAddress = new TextBox();
            txtAddress.Location = new Point(160, y);
            txtAddress.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtAddress);
            y += 35;

            // Дата рождения
            Label lblBirthDate = new Label();
            lblBirthDate.Text = "Дата рождения:";
            lblBirthDate.Location = new Point(30, y);
            lblBirthDate.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblBirthDate);

            dtpBirthDate = new DateTimePicker();
            dtpBirthDate.Location = new Point(160, y);
            dtpBirthDate.Size = new Size(controlWidth, 23);
            dtpBirthDate.Value = new DateTime(1990, 1, 1);
            dtpBirthDate.Format = DateTimePickerFormat.Short;
            this.Controls.Add(dtpBirthDate);
            y += 35;

            // Дата приема
            Label lblHireDate = new Label();
            lblHireDate.Text = "Дата приема:";
            lblHireDate.Location = new Point(30, y);
            lblHireDate.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblHireDate);

            dtpHireDate = new DateTimePicker();
            dtpHireDate.Location = new Point(160, y);
            dtpHireDate.Size = new Size(controlWidth, 23);
            dtpHireDate.Value = DateTime.Now;
            dtpHireDate.Format = DateTimePickerFormat.Short;
            this.Controls.Add(dtpHireDate);
            y += 35;

            // Зарплата
            Label lblSalary = new Label();
            lblSalary.Text = "Зарплата (руб.):";
            lblSalary.Location = new Point(30, y);
            lblSalary.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblSalary);

            numSalary = new NumericUpDown();
            numSalary.Location = new Point(160, y);
            numSalary.Size = new Size(controlWidth, 23);
            numSalary.Minimum = 0;
            numSalary.Maximum = 1000000;
            numSalary.Value = 50000;
            numSalary.DecimalPlaces = 2;
            this.Controls.Add(numSalary);
            y += 40;

            // Кнопки
            Panel buttonPanel = new Panel();
            buttonPanel.Location = new Point(30, y);
            buttonPanel.Size = new Size(430, 50);

            btnSave = new Button();
            btnSave.Text = "Сохранить";
            btnSave.Location = new Point(50, 10);
            btnSave.Size = new Size(100, 35);
            btnSave.BackColor = Color.FromArgb(46, 204, 113);
            btnSave.ForeColor = Color.White;
            btnSave.Click += BtnSave_Click;
            buttonPanel.Controls.Add(btnSave);

            btnCancel = new Button();
            btnCancel.Text = "Отмена";
            btnCancel.Location = new Point(165, 10);
            btnCancel.Size = new Size(100, 35);
            btnCancel.BackColor = Color.FromArgb(149, 165, 166);
            btnCancel.ForeColor = Color.White;
            btnCancel.Click += (s, e) => this.DialogResult = DialogResult.Cancel;
            buttonPanel.Controls.Add(btnCancel);

            if (employeeId.HasValue)
            {
                btnDelete = new Button();
                btnDelete.Text = "Удалить";
                btnDelete.Location = new Point(280, 10);
                btnDelete.Size = new Size(100, 35);
                btnDelete.BackColor = Color.FromArgb(231, 76, 60);
                btnDelete.ForeColor = Color.White;
                btnDelete.Click += BtnDelete_Click;
                buttonPanel.Controls.Add(btnDelete);
            }

            this.Controls.Add(buttonPanel);
        }

        private void LoadDepartments()
        {
            try
            {
                // Можно загрузить отделы из базы данных
                // string query = "SELECT DepartmentID, DepartmentName FROM Departments ORDER BY DepartmentName";
                // DataTable dt = dbHelper.ExecuteQuery(query);
                // cmbDepartment.DataSource = dt;
                // cmbDepartment.DisplayMember = "DepartmentName";
                // cmbDepartment.ValueMember = "DepartmentID";
                
                // Или использовать статический список
                cmbDepartment.Items.AddRange(new string[] {
                    "Продажи",
                    "Сервис",
                    "Администрация",
                    "Бухгалтерия",
                    "Склад",
                    "IT-отдел"
                });
                cmbDepartment.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки отделов: " + ex.Message, "Ошибка");
            }
        }

        private void LoadEmployeeData()
        {
            try
            {
                string query = "SELECT * FROM Employees WHERE EmployeeID = @EmployeeID";
                DataTable dt = dbHelper.ExecuteQuery(query, 
                    new MySqlParameter("@EmployeeID", employeeId.Value));
                
                if (dt.Rows.Count > 0)
                {
                    DataRow row = dt.Rows[0];
                    
                    txtFirstName.Text = row["FirstName"].ToString();
                    txtLastName.Text = row["LastName"].ToString();
                    txtPosition.Text = row["Position"].ToString();
                    txtPhone.Text = row["Phone"].ToString();
                    txtEmail.Text = row["Email"].ToString();
                    
                    if (row["Address"] != DBNull.Value)
                    {
                        txtAddress.Text = row["Address"].ToString();
                    }
                    
                    if (row["BirthDate"] != DBNull.Value)
                    {
                        dtpBirthDate.Value = Convert.ToDateTime(row["BirthDate"]);
                    }
                    
                    if (row["HireDate"] != DBNull.Value)
                    {
                        dtpHireDate.Value = Convert.ToDateTime(row["HireDate"]);
                    }
                    
                    if (row["Salary"] != DBNull.Value)
                    {
                        numSalary.Value = Convert.ToDecimal(row["Salary"]);
                    }
                    
                    if (row["Department"] != DBNull.Value)
                    {
                        string department = row["Department"].ToString();
                        for (int i = 0; i < cmbDepartment.Items.Count; i++)
                        {
                            if (cmbDepartment.Items[i].ToString() == department)
                            {
                                cmbDepartment.SelectedIndex = i;
                                break;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки данных сотрудника: " + ex.Message, "Ошибка");
            }
        }

        private void BtnSave_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtFirstName.Text) || string.IsNullOrWhiteSpace(txtLastName.Text))
            {
                MessageBox.Show("Введите имя и фамилию сотрудника", "Ошибка");
                return;
            }

            if (string.IsNullOrWhiteSpace(txtPosition.Text))
            {
                MessageBox.Show("Введите должность сотрудника", "Ошибка");
                return;
            }

            try
            {
                if (employeeId.HasValue)
                {
                    // Обновление существующего сотрудника
                    string query = @"
                        UPDATE Employees 
                        SET FirstName = @FirstName,
                            LastName = @LastName,
                            Position = @Position,
                            Department = @Department,
                            Phone = @Phone,
                            Email = @Email,
                            Address = @Address,
                            BirthDate = @BirthDate,
                            HireDate = @HireDate,
                            Salary = @Salary
                        WHERE EmployeeID = @EmployeeID";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@FirstName", txtFirstName.Text),
                        new MySqlParameter("@LastName", txtLastName.Text),
                        new MySqlParameter("@Position", txtPosition.Text),
                        new MySqlParameter("@Department", cmbDepartment.Text),
                        new MySqlParameter("@Phone", txtPhone.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Address", txtAddress.Text),
                        new MySqlParameter("@BirthDate", dtpBirthDate.Value),
                        new MySqlParameter("@HireDate", dtpHireDate.Value),
                        new MySqlParameter("@Salary", numSalary.Value),
                        new MySqlParameter("@EmployeeID", employeeId.Value)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                else
                {
                    // Добавление нового сотрудника
                    string query = @"
                        INSERT INTO Employees (FirstName, LastName, Position, Department, Phone, Email, Address, BirthDate, HireDate, Salary)
                        VALUES (@FirstName, @LastName, @Position, @Department, @Phone, @Email, @Address, @BirthDate, @HireDate, @Salary)";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@FirstName", txtFirstName.Text),
                        new MySqlParameter("@LastName", txtLastName.Text),
                        new MySqlParameter("@Position", txtPosition.Text),
                        new MySqlParameter("@Department", cmbDepartment.Text),
                        new MySqlParameter("@Phone", txtPhone.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Address", txtAddress.Text),
                        new MySqlParameter("@BirthDate", dtpBirthDate.Value),
                        new MySqlParameter("@HireDate", dtpHireDate.Value),
                        new MySqlParameter("@Salary", numSalary.Value)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            catch (MySqlException ex) when (ex.Number == 1062)
            {
                MessageBox.Show("Сотрудник с таким email или телефоном уже существует", "Ошибка");
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка сохранения сотрудника: " + ex.Message, "Ошибка");
            }
        }

        private void BtnDelete_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Вы уверены, что хотите удалить этого сотрудника?", 
                "Подтверждение удаления", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
            {
                try
                {
                    // Проверяем, есть ли у сотрудника продажи
                    string checkQuery = "SELECT COUNT(*) FROM Sales WHERE EmployeeID = @EmployeeID";
                    int salesCount = Convert.ToInt32(dbHelper.ExecuteScalar(checkQuery, 
                        new MySqlParameter("@EmployeeID", employeeId.Value)));
                    
                    if (salesCount > 0)
                    {
                        MessageBox.Show("Невозможно удалить сотрудника, который оформил продажи.\n" +
                                      "Вы можете уволить его, установив дату увольнения.", 
                                      "Ошибка", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                    
                    string query = "DELETE FROM Employees WHERE EmployeeID = @EmployeeID";
                    dbHelper.ExecuteNonQuery(query, new MySqlParameter("@EmployeeID", employeeId.Value));
                    
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Ошибка удаления сотрудника: " + ex.Message, "Ошибка");
                }
            }
        }
    }
}