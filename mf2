// –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ MainForm –ø–æ—Å–ª–µ LoadUsers –º–µ—Ç–æ–¥–∞

        private void LoadUsers()
        {
            string query = @"
                SELECT 
                    id as 'ID',
                    username as '–õ–æ–≥–∏–Ω',
                    full_name as '–§–ò–û',
                    email as 'Email',
                    role as '–†–æ–ª—å',
                    DATE_FORMAT(created_at, '%d.%m.%Y %H:%i') as '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
                    CASE WHEN is_active THEN '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' ELSE '‚ùå –ù–µ –∞–∫—Ç–∏–≤–µ–Ω' END as '–°—Ç–∞—Ç—É—Å'
                FROM users
                ORDER BY role, username";
            DataTable dt = dbHelper.ExecuteQuery(query);
            dataGridViewUsers.DataSource = dt;
        }

        private void UpdateStatistics()
        {
            try
            {
                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
                string totalCarsQuery = "SELECT COUNT(*) FROM Cars";
                DataTable totalCarsDt = dbHelper.ExecuteQuery(totalCarsQuery);
                if (totalCarsDt.Rows.Count > 0)
                {
                    lblStatsTotalCars.Text = totalCarsDt.Rows[0][0].ToString();
                }

                // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –Ω–∞–ª–∏—á–∏–∏
                string availableCarsQuery = "SELECT COUNT(*) FROM Cars WHERE InStock = TRUE";
                DataTable availableCarsDt = dbHelper.ExecuteQuery(availableCarsQuery);
                if (availableCarsDt.Rows.Count > 0)
                {
                    lblStatsAvailableCars.Text = availableCarsDt.Rows[0][0].ToString();
                }

                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂
                string totalSalesQuery = "SELECT COUNT(*) FROM Sales";
                DataTable totalSalesDt = dbHelper.ExecuteQuery(totalSalesQuery);
                if (totalSalesDt.Rows.Count > 0)
                {
                    lblStatsTotalSales.Text = totalSalesDt.Rows[0][0].ToString();
                }

                // –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
                string totalRevenueQuery = "SELECT SUM(SalePrice) FROM Sales";
                DataTable totalRevenueDt = dbHelper.ExecuteQuery(totalRevenueQuery);
                if (totalRevenueDt.Rows.Count > 0 && totalRevenueDt.Rows[0][0] != DBNull.Value)
                {
                    decimal revenue = Convert.ToDecimal(totalRevenueDt.Rows[0][0]);
                    lblStatsTotalRevenue.Text = $"{revenue:N0} —Ä—É–±.";
                }
                else
                {
                    lblStatsTotalRevenue.Text = "0 —Ä—É–±.";
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void LoadSalesStatistics()
        {
            string query = @"
                SELECT 
                    DATE_FORMAT(SaleDate, '%Y-%m') as '–ú–µ—Å—è—Ü',
                    COUNT(*) as '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂',
                    SUM(SalePrice) as '–û–±—â–∞—è —Å—É–º–º–∞',
                    AVG(SalePrice) as '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫'
                FROM Sales
                GROUP BY DATE_FORMAT(SaleDate, '%Y-%m')
                ORDER BY DATE_FORMAT(SaleDate, '%Y-%m') DESC
                LIMIT 12";
            DataTable dt = dbHelper.ExecuteQuery(query);
            dataGridViewStats.DataSource = dt;
        }

        private void BtnAddBrand_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtBrandName.Text))
            {
                MessageBox.Show("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–∏", "–û—à–∏–±–∫–∞");
                return;
            }

            try
            {
                string query = "INSERT INTO Brands (BrandName, Country) VALUES (@BrandName, @Country)";
                MySqlParameter[] parameters = {
                    new MySqlParameter("@BrandName", txtBrandName.Text),
                    new MySqlParameter("@Country", txtCountry.Text)
                };
                
                dbHelper.ExecuteNonQuery(query, parameters);
                
                MessageBox.Show("–ú–∞—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞", "–£—Å–ø–µ—Ö");
                txtBrandName.Text = "";
                txtCountry.Text = "";
                LoadBrands();
                LoadComboBoxData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnAddCar_Click(object sender, EventArgs e)
        {
            if (cmbBrands.SelectedIndex == -1 || string.IsNullOrWhiteSpace(txtModel.Text))
            {
                MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è", "–û—à–∏–±–∫–∞");
                return;
            }

            try
            {
                string query = @"
                    INSERT INTO Cars (BrandID, Model, Year, Color, Price, VIN, InStock)
                    VALUES (@BrandID, @Model, @Year, @Color, @Price, @VIN, TRUE)";
                
                MySqlParameter[] parameters = {
                    new MySqlParameter("@BrandID", cmbBrands.SelectedValue),
                    new MySqlParameter("@Model", txtModel.Text),
                    new MySqlParameter("@Year", (int)numYear.Value),
                    new MySqlParameter("@Color", txtColor.Text),
                    new MySqlParameter("@Price", numPrice.Value),
                    new MySqlParameter("@VIN", txtVIN.Text)
                };
                
                dbHelper.ExecuteNonQuery(query, parameters);
                
                MessageBox.Show("–ê–≤—Ç–æ–º–æ–±–∏–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω", "–£—Å–ø–µ—Ö");
                
                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
                txtModel.Text = "";
                txtColor.Text = "";
                txtVIN.Text = "";
                numPrice.Value = 1000000;
                
                LoadCars();
                LoadComboBoxData();
                UpdateStatistics();
            }
            catch (MySqlException ex) when (ex.Number == 1062) // Duplicate entry
            {
                MessageBox.Show("–ê–≤—Ç–æ–º–æ–±–∏–ª—å —Å —Ç–∞–∫–∏–º VIN —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç", "–û—à–∏–±–∫–∞");
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnAddSale_Click(object sender, EventArgs e)
        {
            if (cmbCar.SelectedIndex == -1 || cmbCustomer.SelectedIndex == -1 || cmbEmployee.SelectedIndex == -1)
            {
                MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å, –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", "–û—à–∏–±–∫–∞");
                return;
            }

            try
            {
                // –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                dbHelper.ExecuteNonQuery("START TRANSACTION");
                
                // 1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É
                string saleQuery = @"
                    INSERT INTO Sales (CarID, CustomerID, EmployeeID, SaleDate, SalePrice)
                    VALUES (@CarID, @CustomerID, @EmployeeID, @SaleDate, @SalePrice)";
                
                MySqlParameter[] saleParams = {
                    new MySqlParameter("@CarID", cmbCar.SelectedValue),
                    new MySqlParameter("@CustomerID", cmbCustomer.SelectedValue),
                    new MySqlParameter("@EmployeeID", cmbEmployee.SelectedValue),
                    new MySqlParameter("@SaleDate", dtpSaleDate.Value),
                    new MySqlParameter("@SalePrice", numSalePrice.Value)
                };
                
                dbHelper.ExecuteNonQuery(saleQuery, saleParams);
                
                // 2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è
                string updateCarQuery = "UPDATE Cars SET InStock = FALSE WHERE CarID = @CarID";
                dbHelper.ExecuteNonQuery(updateCarQuery, new MySqlParameter("@CarID", cmbCar.SelectedValue));
                
                // 3. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                dbHelper.ExecuteNonQuery("COMMIT");
                
                MessageBox.Show("–ü—Ä–æ–¥–∞–∂–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞", "–£—Å–ø–µ—Ö");
                
                // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                LoadCars();
                LoadSales();
                LoadComboBoxData();
                UpdateStatistics();
                LoadSalesStatistics();
            }
            catch (Exception ex)
            {
                // –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                dbHelper.ExecuteNonQuery("ROLLBACK");
                MessageBox.Show("–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnSearchCars_Click(object sender, EventArgs e)
        {
            string searchText = txtSearchCar.Text.Trim();
            if (string.IsNullOrWhiteSpace(searchText))
            {
                LoadCars();
                return;
            }

            try
            {
                string query = @"
                    SELECT 
                        c.CarID as 'ID',
                        b.BrandName as '–ú–∞—Ä–∫–∞',
                        c.Model as '–ú–æ–¥–µ–ª—å',
                        c.Year as '–ì–æ–¥',
                        c.Color as '–¶–≤–µ—Ç', 
                        FORMAT(c.Price, 0) as '–¶–µ–Ω–∞',
                        c.VIN as 'VIN-–∫–æ–¥',
                        CASE WHEN c.InStock THEN '–í –Ω–∞–ª–∏—á–∏–∏' ELSE '–ü—Ä–æ–¥–∞–Ω–æ' END as '–°—Ç–∞—Ç—É—Å'
                    FROM Cars c 
                    JOIN Brands b ON c.BrandID = b.BrandID
                    WHERE b.BrandName LIKE @Search OR 
                          c.Model LIKE @Search OR 
                          c.Color LIKE @Search OR
                          c.VIN LIKE @Search
                    ORDER BY b.BrandName, c.Model";
                
                MySqlParameter parameter = new MySqlParameter("@Search", $"%{searchText}%");
                DataTable dt = dbHelper.ExecuteQuery(query, parameter);
                dataGridViewCars.DataSource = dt;
                
                if (dt.Rows.Count == 0)
                {
                    MessageBox.Show("–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnAddUser_Click(object sender, EventArgs e)
        {
            using (var form = new UserForm(null, dbHelper))
            {
                if (form.ShowDialog() == DialogResult.OK)
                {
                    LoadUsers();
                    MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω", "–£—Å–ø–µ—Ö");
                }
            }
        }

        private void BtnEditUser_Click(object sender, EventArgs e)
        {
            if (dataGridViewUsers.SelectedRows.Count == 0)
            {
                MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                return;
            }

            int userId = Convert.ToInt32(dataGridViewUsers.SelectedRows[0].Cells["ID"].Value);
            
            using (var form = new UserForm(userId, dbHelper))
            {
                if (form.ShowDialog() == DialogResult.OK)
                {
                    LoadUsers();
                    MessageBox.Show("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã", "–£—Å–ø–µ—Ö");
                }
            }
        }

        private void BtnDeleteUser_Click(object sender, EventArgs e)
        {
            if (dataGridViewUsers.SelectedRows.Count == 0)
            {
                MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                return;
            }

            if (MessageBox.Show("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?", 
                "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
            {
                return;
            }

            try
            {
                int userId = Convert.ToInt32(dataGridViewUsers.SelectedRows[0].Cells["ID"].Value);
                string username = dataGridViewUsers.SelectedRows[0].Cells["–õ–æ–≥–∏–Ω"].Value.ToString();
                
                // –ù–µ–ª—å–∑—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è
                if (username == currentUsername)
                {
                    MessageBox.Show("–ù–µ–ª—å–∑—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å", "–û—à–∏–±–∫–∞");
                    return;
                }
                
                string query = "UPDATE users SET is_active = FALSE WHERE id = @UserId";
                dbHelper.ExecuteNonQuery(query, new MySqlParameter("@UserId", userId));
                
                LoadUsers();
                MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω", "–£—Å–ø–µ—Ö");
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnActivateUser_Click(object sender, EventArgs e)
        {
            if (dataGridViewUsers.SelectedRows.Count == 0)
            {
                MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                return;
            }

            try
            {
                int userId = Convert.ToInt32(dataGridViewUsers.SelectedRows[0].Cells["ID"].Value);
                string query = "UPDATE users SET is_active = TRUE WHERE id = @UserId";
                dbHelper.ExecuteNonQuery(query, new MySqlParameter("@UserId", userId));
                
                LoadUsers();
                MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω", "–£—Å–ø–µ—Ö");
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnAutoSelect_Click(object sender, EventArgs e)
        {
            try
            {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                string query = @"
                    SELECT e.EmployeeID 
                    FROM Employees e
                    JOIN users u ON u.full_name LIKE CONCAT('%', e.FirstName, '%', e.LastName, '%')
                    WHERE u.username = @Username";
                
                MySqlParameter param = new MySqlParameter("@Username", currentUsername);
                DataTable dt = dbHelper.ExecuteQuery(query, param);
                
                if (dt.Rows.Count > 0)
                {
                    int employeeId = Convert.ToInt32(dt.Rows[0]["EmployeeID"]);
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤ ComboBox
                    for (int i = 0; i < cmbEmployee.Items.Count; i++)
                    {
                        DataRowView row = cmbEmployee.Items[i] as DataRowView;
                        if (row != null && Convert.ToInt32(row["EmployeeID"]) == employeeId)
                        {
                            cmbEmployee.SelectedIndex = i;
                            break;
                        }
                    }
                }
                else
                {
                    MessageBox.Show("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–≤—ã–±–æ—Ä–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnUpdateStats_Click(object sender, EventArgs e)
        {
            UpdateStatistics();
            LoadSalesStatistics();
            MessageBox.Show("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
        }

        private void BtnRefresh_Click(object sender, EventArgs e)
        {
            RefreshAllData();
            MessageBox.Show("–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
        }

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è DataGridView (–¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)
        private void AddContextMenus()
        {
            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
            ContextMenuStrip carsMenu = new ContextMenuStrip();
            carsMenu.Items.Add("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", null, EditCar_Click);
            carsMenu.Items.Add("–£–¥–∞–ª–∏—Ç—å", null, DeleteCar_Click);
            carsMenu.Items.Add("–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏", null, ShowCarDetails_Click);
            dataGridViewCars.ContextMenuStrip = carsMenu;

            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –ø—Ä–æ–¥–∞–∂
            ContextMenuStrip salesMenu = new ContextMenuStrip();
            salesMenu.Items.Add("–û—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É", null, CancelSale_Click);
            salesMenu.Items.Add("–ü–µ—á–∞—Ç—å —á–µ–∫–∞", null, PrintReceipt_Click);
            dataGridViewSales.ContextMenuStrip = salesMenu;

            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞/–º–µ–Ω–µ–¥–∂–µ—Ä–∞)
            if (currentRole == "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" || currentRole == "–ú–µ–Ω–µ–¥–∂–µ—Ä")
            {
                ContextMenuStrip customersMenu = new ContextMenuStrip();
                customersMenu.Items.Add("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", null, EditCustomer_Click);
                customersMenu.Items.Add("–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É", null, AddPurchaseForCustomer_Click);
                dataGridViewCustomers.ContextMenuStrip = customersMenu;
            }
        }

        private void EditCar_Click(object sender, EventArgs e)
        {
            if (currentRole != "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" && currentRole != "–ú–µ–Ω–µ–¥–∂–µ—Ä")
            {
                MessageBox.Show("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π", "–û—à–∏–±–∫–∞ –ø—Ä–∞–≤");
                return;
            }

            if (dataGridViewCars.SelectedRows.Count > 0)
            {
                int carId = Convert.ToInt32(dataGridViewCars.SelectedRows[0].Cells["ID"].Value);
                using (var form = new CarForm(carId, dbHelper))
                {
                    if (form.ShowDialog() == DialogResult.OK)
                    {
                        LoadCars();
                        LoadComboBoxData();
                    }
                }
            }
        }

        private void DeleteCar_Click(object sender, EventArgs e)
        {
            if (currentRole != "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
            {
                MessageBox.Show("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π", "–û—à–∏–±–∫–∞ –ø—Ä–∞–≤");
                return;
            }

            if (dataGridViewCars.SelectedRows.Count > 0)
            {
                if (MessageBox.Show("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å?", 
                    "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
                {
                    try
                    {
                        int carId = Convert.ToInt32(dataGridViewCars.SelectedRows[0].Cells["ID"].Value);
                        string query = "DELETE FROM Cars WHERE CarID = @CarId";
                        dbHelper.ExecuteNonQuery(query, new MySqlParameter("@CarId", carId));
                        
                        LoadCars();
                        LoadComboBoxData();
                        UpdateStatistics();
                        
                        MessageBox.Show("–ê–≤—Ç–æ–º–æ–±–∏–ª—å —É–¥–∞–ª–µ–Ω", "–£—Å–ø–µ—Ö");
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + ex.Message, "–û—à–∏–±–∫–∞");
                    }
                }
            }
        }

        private void ShowCarDetails_Click(object sender, EventArgs e)
        {
            if (dataGridViewCars.SelectedRows.Count > 0)
            {
                int carId = Convert.ToInt32(dataGridViewCars.SelectedRows[0].Cells["ID"].Value);
                string carInfo = dataGridViewCars.SelectedRows[0].Cells["–ú–∞—Ä–∫–∞"].Value.ToString() + " " +
                               dataGridViewCars.SelectedRows[0].Cells["–ú–æ–¥–µ–ª—å"].Value.ToString();
                
                MessageBox.Show($"–î–µ—Ç–∞–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:\n" +
                              $"ID: {carId}\n" +
                              $"–ú–∞—Ä–∫–∞: {dataGridViewCars.SelectedRows[0].Cells["–ú–∞—Ä–∫–∞"].Value}\n" +
                              $"–ú–æ–¥–µ–ª—å: {dataGridViewCars.SelectedRows[0].Cells["–ú–æ–¥–µ–ª—å"].Value}\n" +
                              $"–ì–æ–¥: {dataGridViewCars.SelectedRows[0].Cells["–ì–æ–¥"].Value}\n" +
                              $"–¶–≤–µ—Ç: {dataGridViewCars.SelectedRows[0].Cells["–¶–≤–µ—Ç"].Value}\n" +
                              $"–¶–µ–Ω–∞: {dataGridViewCars.SelectedRows[0].Cells["–¶–µ–Ω–∞"].Value}\n" +
                              $"–°—Ç–∞—Ç—É—Å: {dataGridViewCars.SelectedRows[0].Cells["–°—Ç–∞—Ç—É—Å"].Value}",
                              $"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ {carInfo}");
            }
        }

        private void CancelSale_Click(object sender, EventArgs e)
        {
            if (currentRole != "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
            {
                MessageBox.Show("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å –ø—Ä–æ–¥–∞–∂–∏", "–û—à–∏–±–∫–∞ –ø—Ä–∞–≤");
                return;
            }

            if (dataGridViewSales.SelectedRows.Count > 0)
            {
                int saleId = Convert.ToInt32(dataGridViewSales.SelectedRows[0].Cells["ID"].Value);
                string carInfo = dataGridViewSales.SelectedRows[0].Cells["–ú–∞—Ä–∫–∞"].Value.ToString() + " " +
                               dataGridViewSales.SelectedRows[0].Cells["–ú–æ–¥–µ–ª—å"].Value.ToString();
                
                if (MessageBox.Show($"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É {carInfo}?\n" +
                                  $"–≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –Ω–∞–ª–∏—á–∏–µ.",
                                  "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
                {
                    try
                    {
                        // –ü–æ–ª—É—á–∞–µ–º CarID –∏–∑ –ø—Ä–æ–¥–∞–∂–∏
                        string getCarIdQuery = "SELECT CarID FROM Sales WHERE SaleID = @SaleId";
                        DataTable dt = dbHelper.ExecuteQuery(getCarIdQuery, new MySqlParameter("@SaleId", saleId));
                        
                        if (dt.Rows.Count > 0)
                        {
                            int carId = Convert.ToInt32(dt.Rows[0]["CarID"]);
                            
                            // –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                            dbHelper.ExecuteNonQuery("START TRANSACTION");
                            
                            // –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É
                            string deleteSaleQuery = "DELETE FROM Sales WHERE SaleID = @SaleId";
                            dbHelper.ExecuteNonQuery(deleteSaleQuery, new MySqlParameter("@SaleId", saleId));
                            
                            // –í–µ—Ä–Ω—É—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –Ω–∞–ª–∏—á–∏–µ
                            string updateCarQuery = "UPDATE Cars SET InStock = TRUE WHERE CarID = @CarId";
                            dbHelper.ExecuteNonQuery(updateCarQuery, new MySqlParameter("@CarId", carId));
                            
                            // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                            dbHelper.ExecuteNonQuery("COMMIT");
                            
                            LoadCars();
                            LoadSales();
                            LoadComboBoxData();
                            UpdateStatistics();
                            LoadSalesStatistics();
                            
                            MessageBox.Show("–ü—Ä–æ–¥–∞–∂–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞, –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –Ω–∞–ª–∏—á–∏–µ", "–£—Å–ø–µ—Ö");
                        }
                    }
                    catch (Exception ex)
                    {
                        dbHelper.ExecuteNonQuery("ROLLBACK");
                        MessageBox.Show("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
                    }
                }
            }
        }

        private void PrintReceipt_Click(object sender, EventArgs e)
        {
            if (dataGridViewSales.SelectedRows.Count > 0)
            {
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ —á–µ–∫–∞
                string receipt = "=== –ß–ï–ö –ü–†–û–î–ê–ñ–ò –ê–í–¢–û–ú–û–ë–ò–õ–Ø ===\n\n";
                receipt += $"–ù–æ–º–µ—Ä –ø—Ä–æ–¥–∞–∂–∏: {dataGridViewSales.SelectedRows[0].Cells["ID"].Value}\n";
                receipt += $"–î–∞—Ç–∞: {dataGridViewSales.SelectedRows[0].Cells["–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏"].Value}\n";
                receipt += $"–ê–≤—Ç–æ–º–æ–±–∏–ª—å: {dataGridViewSales.SelectedRows[0].Cells["–ú–∞—Ä–∫–∞"].Value} " +
                          $"{dataGridViewSales.SelectedRows[0].Cells["–ú–æ–¥–µ–ª—å"].Value}\n";
                receipt += $"–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {dataGridViewSales.SelectedRows[0].Cells["–ü–æ–∫—É–ø–∞—Ç–µ–ª—å"].Value}\n";
                receipt += $"–°–æ—Ç—Ä—É–¥–Ω–∏–∫: {dataGridViewSales.SelectedRows[0].Cells["–°–æ—Ç—Ä—É–¥–Ω–∏–∫"].Value}\n";
                receipt += $"–°—É–º–º–∞: {dataGridViewSales.SelectedRows[0].Cells["–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏"].Value} —Ä—É–±.\n\n";
                receipt += $"–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏: {DateTime.Now:dd.MM.yyyy HH:mm}\n";
                receipt += "=== –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! ===";
                
                MessageBox.Show(receipt, "–ß–µ–∫ –ø—Ä–æ–¥–∞–∂–∏", MessageBoxButtons.OK, MessageBoxIcon.Information);
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
                SaveFileDialog saveDialog = new SaveFileDialog();
                saveDialog.Filter = "–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (*.txt)|*.txt|–í—Å–µ —Ñ–∞–π–ª—ã (*.*)|*.*";
                saveDialog.FileName = $"—á–µ–∫_–ø—Ä–æ–¥–∞–∂–∏_{dataGridViewSales.SelectedRows[0].Cells["ID"].Value}.txt";
                
                if (saveDialog.ShowDialog() == DialogResult.OK)
                {
                    try
                    {
                        System.IO.File.WriteAllText(saveDialog.FileName, receipt);
                        MessageBox.Show($"–ß–µ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {saveDialog.FileName}", "–£—Å–ø–µ—Ö");
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
                    }
                }
            }
        }

        private void EditCustomer_Click(object sender, EventArgs e)
        {
            if (dataGridViewCustomers.SelectedRows.Count > 0)
            {
                int customerId = Convert.ToInt32(dataGridViewCustomers.SelectedRows[0].Cells["ID"].Value);
                using (var form = new CustomerForm(customerId, dbHelper))
                {
                    if (form.ShowDialog() == DialogResult.OK)
                    {
                        LoadCustomers();
                        LoadComboBoxData();
                    }
                }
            }
        }

        private void AddPurchaseForCustomer_Click(object sender, EventArgs e)
        {
            if (dataGridViewCustomers.SelectedRows.Count > 0)
            {
                int customerId = Convert.ToInt32(dataGridViewCustomers.SelectedRows[0].Cells["ID"].Value);
                string customerName = dataGridViewCustomers.SelectedRows[0].Cells["–§–∞–º–∏–ª–∏—è"].Value.ToString() + " " +
                                    dataGridViewCustomers.SelectedRows[0].Cells["–ò–º—è"].Value.ToString();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –≤ ComboBox –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø—Ä–æ–¥–∞–∂
                tabControl1.SelectedTab = tabSales;
                
                // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –≤ ComboBox
                for (int i = 0; i < cmbCustomer.Items.Count; i++)
                {
                    DataRowView row = cmbCustomer.Items[i] as DataRowView;
                    if (row != null && Convert.ToInt32(row["CustomerID"]) == customerId)
                    {
                        cmbCustomer.SelectedIndex = i;
                        MessageBox.Show($"–í—ã–±—Ä–∞–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—å: {customerName}\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.", 
                                      "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω");
                        break;
                    }
                }
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –º–µ–Ω—é
        public MainForm(string username, string role, string fullName)
        {
            currentUsername = username;
            currentRole = role;
            currentFullName = fullName;
            
            InitializeComponent();
            try
            {
                dbHelper = new DatabaseHelper();
                LoadComboBoxData();
                RefreshAllData();
                SetupPermissions();
                AddContextMenus(); // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        // –ú–µ—Ç–æ–¥ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Excel (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
        private void ExportToExcel(DataGridView dataGrid, string sheetName)
        {
            SaveFileDialog saveDialog = new SaveFileDialog();
            saveDialog.Filter = "CSV —Ñ–∞–π–ª—ã (*.csv)|*.csv|–í—Å–µ —Ñ–∞–π–ª—ã (*.*)|*.*";
            saveDialog.FileName = $"{sheetName}_{DateTime.Now:yyyyMMdd_HHmm}.csv";
            
            if (saveDialog.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    using (System.IO.StreamWriter writer = new System.IO.StreamWriter(saveDialog.FileName, false, System.Text.Encoding.UTF8))
                    {
                        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                        for (int i = 0; i < dataGrid.Columns.Count; i++)
                        {
                            writer.Write(dataGrid.Columns[i].HeaderText);
                            if (i < dataGrid.Columns.Count - 1) writer.Write(",");
                        }
                        writer.WriteLine();
                        
                        // –î–∞–Ω–Ω—ã–µ
                        foreach (DataGridViewRow row in dataGrid.Rows)
                        {
                            for (int i = 0; i < dataGrid.Columns.Count; i++)
                            {
                                if (row.Cells[i].Value != null)
                                {
                                    string value = row.Cells[i].Value.ToString();
                                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–ø—è—Ç—ã–µ
                                    if (value.Contains(",")) value = $"\"{value}\"";
                                    writer.Write(value);
                                }
                                if (i < dataGrid.Columns.Count - 1) writer.Write(",");
                            }
                            writer.WriteLine();
                        }
                    }
                    
                    MessageBox.Show($"–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª: {saveDialog.FileName}", "–£—Å–ø–µ—Ö");
                }
                catch (Exception ex)
                {
                    MessageBox.Show("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
                }
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–∏ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏)
        private void AddExportButtons()
        {
            // –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
            Button btnExportCars = new Button();
            btnExportCars.Text = "üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV";
            btnExportCars.Location = new Point(1050, 15);
            btnExportCars.Size = new Size(120, 27);
            btnExportCars.Click += (s, e) => ExportToExcel(dataGridViewCars, "–ê–≤—Ç–æ–º–æ–±–∏–ª–∏");
            
            // –ù–∞–π—Ç–∏ –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
            foreach (Control control in tabCars.Controls)
            {
                if (control is Panel panel && panel.Controls.Count > 10) // –ò—â–µ–º –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞
                {
                    panel.Controls.Add(btnExportCars);
                    break;
                }
            }
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Ñ–æ—Ä–º –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    public class UserForm : Form
    {
        private TextBox txtUsername;
        private TextBox txtPassword;
        private TextBox txtFullName;
        private TextBox txtEmail;
        private ComboBox cmbRole;
        private CheckBox chkIsActive;
        private Button btnSave;
        private Button btnCancel;
        
        private int? userId;
        private DatabaseHelper dbHelper;

        public UserForm(int? id, DatabaseHelper dbHelper)
        {
            this.userId = id;
            this.dbHelper = dbHelper;
            InitializeComponent();
            if (id.HasValue) LoadUserData();
        }

        private void InitializeComponent()
        {
            this.Text = userId.HasValue ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" : "–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            this.Size = new Size(400, 350);
            this.StartPosition = FormStartPosition.CenterParent;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;

            int y = 20;
            int labelWidth = 120;
            int controlWidth = 200;

            // Username
            Label lblUsername = new Label();
            lblUsername.Text = "–õ–æ–≥–∏–Ω:";
            lblUsername.Location = new Point(20, y);
            lblUsername.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblUsername);

            txtUsername = new TextBox();
            txtUsername.Location = new Point(140, y);
            txtUsername.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtUsername);
            y += 35;

            // Password (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            if (!userId.HasValue)
            {
                Label lblPassword = new Label();
                lblPassword.Text = "–ü–∞—Ä–æ–ª—å:";
                lblPassword.Location = new Point(20, y);
                lblPassword.Size = new Size(labelWidth, 25);
                this.Controls.Add(lblPassword);

                txtPassword = new TextBox();
                txtPassword.Location = new Point(140, y);
                txtPassword.Size = new Size(controlWidth, 23);
                txtPassword.UseSystemPasswordChar = true;
                this.Controls.Add(txtPassword);
                y += 35;
            }

            // Full Name
            Label lblFullName = new Label();
            lblFullName.Text = "–§–ò–û:";
            lblFullName.Location = new Point(20, y);
            lblFullName.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblFullName);

            txtFullName = new TextBox();
            txtFullName.Location = new Point(140, y);
            txtFullName.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtFullName);
            y += 35;

            // Email
            Label lblEmail = new Label();
            lblEmail.Text = "Email:";
            lblEmail.Location = new Point(20, y);
            lblEmail.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblEmail);

            txtEmail = new TextBox();
            txtEmail.Location = new Point(140, y);
            txtEmail.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtEmail);
            y += 35;

            // Role
            Label lblRole = new Label();
            lblRole.Text = "–†–æ–ª—å:";
            lblRole.Location = new Point(20, y);
            lblRole.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblRole);

            cmbRole = new ComboBox();
            cmbRole.Location = new Point(140, y);
            cmbRole.Size = new Size(controlWidth, 23);
            cmbRole.DropDownStyle = ComboBoxStyle.DropDownList;
            cmbRole.Items.AddRange(new string[] { "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç" });
            cmbRole.SelectedIndex = 2; // –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            this.Controls.Add(cmbRole);
            y += 35;

            // Is Active (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
            if (userId.HasValue)
            {
                chkIsActive = new CheckBox();
                chkIsActive.Text = "–ê–∫—Ç–∏–≤–µ–Ω";
                chkIsActive.Location = new Point(140, y);
                chkIsActive.Size = new Size(100, 25);
                this.Controls.Add(chkIsActive);
                y += 40;
            }

            // Buttons
            btnSave = new Button();
            btnSave.Text = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            btnSave.Location = new Point(80, y);
            btnSave.Size = new Size(100, 30);
            btnSave.BackColor = Color.FromArgb(46, 204, 113);
            btnSave.ForeColor = Color.White;
            btnSave.Click += BtnSave_Click;
            this.Controls.Add(btnSave);

            btnCancel = new Button();
            btnCancel.Text = "–û—Ç–º–µ–Ω–∞";
            btnCancel.Location = new Point(200, y);
            btnCancel.Size = new Size(100, 30);
            btnCancel.BackColor = Color.FromArgb(149, 165, 166);
            btnCancel.ForeColor = Color.White;
            btnCancel.Click += (s, e) => this.DialogResult = DialogResult.Cancel;
            this.Controls.Add(btnCancel);
        }

        private void LoadUserData()
        {
            try
            {
                string query = "SELECT * FROM users WHERE id = @Id";
                DataTable dt = dbHelper.ExecuteQuery(query, new MySqlParameter("@Id", userId.Value));
                
                if (dt.Rows.Count > 0)
                {
                    DataRow row = dt.Rows[0];
                    txtUsername.Text = row["username"].ToString();
                    txtFullName.Text = row["full_name"].ToString();
                    txtEmail.Text = row["email"].ToString();
                    cmbRole.Text = row["role"].ToString();
                    if (chkIsActive != null)
                        chkIsActive.Checked = Convert.ToBoolean(row["is_active"]);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void BtnSave_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtUsername.Text) || string.IsNullOrWhiteSpace(txtFullName.Text))
            {
                MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è", "–û—à–∏–±–∫–∞");
                return;
            }

            try
            {
                if (userId.HasValue)
                {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    string query = @"
                        UPDATE users 
                        SET username = @Username, 
                            full_name = @FullName, 
                            email = @Email, 
                            role = @Role,
                            is_active = @IsActive
                        WHERE id = @Id";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@Username", txtUsername.Text),
                        new MySqlParameter("@FullName", txtFullName.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Role", cmbRole.Text),
                        new MySqlParameter("@IsActive", chkIsActive?.Checked ?? true),
                        new MySqlParameter("@Id", userId.Value)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                else
                {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (string.IsNullOrWhiteSpace(txtPassword.Text))
                    {
                        MessageBox.Show("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", "–û—à–∏–±–∫–∞");
                        return;
                    }

                    string query = @"
                        INSERT INTO users (username, password, full_name, email, role, is_active)
                        VALUES (@Username, SHA2(@Password, 256), @FullName, @Email, @Role, TRUE)";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@Username", txtUsername.Text),
                        new MySqlParameter("@Password", txtPassword.Text),
                        new MySqlParameter("@FullName", txtFullName.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Role", cmbRole.Text)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            catch (MySqlException ex) when (ex.Number == 1062)
            {
                MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç", "–û—à–∏–±–∫–∞");
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }
    }
}