using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace ApplicantTrackingSystem
{
    public class ApplicantForm : Form
    {
        private int? applicantId;
        private DatabaseHelper dbHelper;
        
        private TextBox txtFirstName, txtLastName, txtEmail, txtPhone, txtAddress;
        private DateTimePicker dtpBirthDate;
        private NumericUpDown numAvgScore;
        private ComboBox cmbEducationType;
        private Button btnSave, btnCancel, btnDelete;

        public ApplicantForm(int? id, DatabaseHelper dbHelper)
        {
            this.applicantId = id;
            this.dbHelper = dbHelper;
            InitializeComponent();
            
            if (id.HasValue)
            {
                LoadApplicantData();
                this.Text = "Редактирование абитуриента";
            }
            else
            {
                this.Text = "Новый абитуриент";
            }
        }

        private void InitializeComponent()
        {
            this.Size = new Size(500, 450);
            this.StartPosition = FormStartPosition.CenterParent;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;

            int y = 20;
            int labelWidth = 120;
            int controlWidth = 200;

            // Имя
            Label lblFirstName = new Label();
            lblFirstName.Text = "Имя:";
            lblFirstName.Location = new Point(30, y);
            lblFirstName.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblFirstName);

            txtFirstName = new TextBox();
            txtFirstName.Location = new Point(160, y);
            txtFirstName.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtFirstName);
            y += 35;

            // Фамилия
            Label lblLastName = new Label();
            lblLastName.Text = "Фамилия:";
            lblLastName.Location = new Point(30, y);
            lblLastName.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblLastName);

            txtLastName = new TextBox();
            txtLastName.Location = new Point(160, y);
            txtLastName.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtLastName);
            y += 35;

            // Email
            Label lblEmail = new Label();
            lblEmail.Text = "Email:";
            lblEmail.Location = new Point(30, y);
            lblEmail.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblEmail);

            txtEmail = new TextBox();
            txtEmail.Location = new Point(160, y);
            txtEmail.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtEmail);
            y += 35;

            // Телефон
            Label lblPhone = new Label();
            lblPhone.Text = "Телефон:";
            lblPhone.Location = new Point(30, y);
            lblPhone.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblPhone);

            txtPhone = new TextBox();
            txtPhone.Location = new Point(160, y);
            txtPhone.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtPhone);
            y += 35;

            // Дата рождения
            Label lblBirthDate = new Label();
            lblBirthDate.Text = "Дата рождения:";
            lblBirthDate.Location = new Point(30, y);
            lblBirthDate.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblBirthDate);

            dtpBirthDate = new DateTimePicker();
            dtpBirthDate.Location = new Point(160, y);
            dtpBirthDate.Size = new Size(controlWidth, 23);
            dtpBirthDate.Value = new DateTime(2000, 1, 1);
            dtpBirthDate.Format = DateTimePickerFormat.Short;
            this.Controls.Add(dtpBirthDate);
            y += 35;

            // Средний балл
            Label lblAvgScore = new Label();
            lblAvgScore.Text = "Средний балл:";
            lblAvgScore.Location = new Point(30, y);
            lblAvgScore.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblAvgScore);

            numAvgScore = new NumericUpDown();
            numAvgScore.Location = new Point(160, y);
            numAvgScore.Size = new Size(80, 23);
            numAvgScore.Minimum = 0;
            numAvgScore.Maximum = 100;
            numAvgScore.DecimalPlaces = 2;
            numAvgScore.Value = 70;
            this.Controls.Add(numAvgScore);
            y += 35;

            // Тип образования
            Label lblEducationType = new Label();
            lblEducationType.Text = "Образование:";
            lblEducationType.Location = new Point(30, y);
            lblEducationType.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblEducationType);

            cmbEducationType = new ComboBox();
            cmbEducationType.Location = new Point(160, y);
            cmbEducationType.Size = new Size(controlWidth, 23);
            cmbEducationType.DropDownStyle = ComboBoxStyle.DropDownList;
            cmbEducationType.Items.AddRange(new string[] { "Среднее", "Среднее специальное", "Неоконченное высшее", "Высшее" });
            cmbEducationType.SelectedIndex = 0;
            this.Controls.Add(cmbEducationType);
            y += 35;

            // Адрес
            Label lblAddress = new Label();
            lblAddress.Text = "Адрес:";
            lblAddress.Location = new Point(30, y);
            lblAddress.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblAddress);

            txtAddress = new TextBox();
            txtAddress.Location = new Point(160, y);
            txtAddress.Size = new Size(controlWidth, 60);
            txtAddress.Multiline = true;
            txtAddress.ScrollBars = ScrollBars.Vertical;
            this.Controls.Add(txtAddress);
            y += 70;

            // Кнопки
            Panel buttonPanel = new Panel();
            buttonPanel.Location = new Point(30, y);
            buttonPanel.Size = new Size(430, 50);

            btnSave = new Button();
            btnSave.Text = "Сохранить";
            btnSave.Location = new Point(50, 10);
            btnSave.Size = new Size(100, 35);
            btnSave.BackColor = Color.FromArgb(46, 204, 113);
            btnSave.ForeColor = Color.White;
            btnSave.Click += BtnSave_Click;
            buttonPanel.Controls.Add(btnSave);

            btnCancel = new Button();
            btnCancel.Text = "Отмена";
            btnCancel.Location = new Point(165, 10);
            btnCancel.Size = new Size(100, 35);
            btnCancel.BackColor = Color.FromArgb(149, 165, 166);
            btnCancel.ForeColor = Color.White;
            btnCancel.Click += (s, e) => this.DialogResult = DialogResult.Cancel;
            buttonPanel.Controls.Add(btnCancel);

            if (applicantId.HasValue)
            {
                btnDelete = new Button();
                btnDelete.Text = "Удалить";
                btnDelete.Location = new Point(280, 10);
                btnDelete.Size = new Size(100, 35);
                btnDelete.BackColor = Color.FromArgb(231, 76, 60);
                btnDelete.ForeColor = Color.White;
                btnDelete.Click += BtnDelete_Click;
                buttonPanel.Controls.Add(btnDelete);
            }

            this.Controls.Add(buttonPanel);
        }

        private void LoadApplicantData()
        {
            try
            {
                string query = "SELECT * FROM applicants WHERE ApplicantID = @ApplicantID";
                DataTable dt = dbHelper.ExecuteQuery(query, 
                    new MySqlParameter("@ApplicantID", applicantId.Value));
                
                if (dt.Rows.Count > 0)
                {
                    DataRow row = dt.Rows[0];
                    
                    txtFirstName.Text = row["FirstName"].ToString();
                    txtLastName.Text = row["LastName"].ToString();
                    txtEmail.Text = row["Email"].ToString();
                    txtPhone.Text = row["Phone"].ToString();
                    
                    if (row["BirthDate"] != DBNull.Value)
                    {
                        dtpBirthDate.Value = Convert.ToDateTime(row["BirthDate"]);
                    }
                    
                    if (row["AverageScore"] != DBNull.Value)
                    {
                        numAvgScore.Value = Convert.ToDecimal(row["AverageScore"]);
                    }
                    
                    if (row["EducationType"] != DBNull.Value)
                    {
                        string educationType = row["EducationType"].ToString();
                        for (int i = 0; i < cmbEducationType.Items.Count; i++)
                        {
                            if (cmbEducationType.Items[i].ToString() == educationType)
                            {
                                cmbEducationType.SelectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    if (row["Address"] != DBNull.Value)
                    {
                        txtAddress.Text = row["Address"].ToString();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки данных абитуриента: " + ex.Message, "Ошибка");
            }
        }

        private void BtnSave_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtFirstName.Text) || string.IsNullOrWhiteSpace(txtLastName.Text))
            {
                MessageBox.Show("Введите имя и фамилию абитуриента", "Ошибка");
                return;
            }

            try
            {
                if (applicantId.HasValue)
                {
                    // Обновление существующего абитуриента
                    string query = @"
                        UPDATE applicants 
                        SET FirstName = @FirstName,
                            LastName = @LastName,
                            Email = @Email,
                            Phone = @Phone,
                            BirthDate = @BirthDate,
                            AverageScore = @AverageScore,
                            EducationType = @EducationType,
                            Address = @Address
                        WHERE ApplicantID = @ApplicantID";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@FirstName", txtFirstName.Text),
                        new MySqlParameter("@LastName", txtLastName.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Phone", txtPhone.Text),
                        new MySqlParameter("@BirthDate", dtpBirthDate.Value),
                        new MySqlParameter("@AverageScore", numAvgScore.Value),
                        new MySqlParameter("@EducationType", cmbEducationType.Text),
                        new MySqlParameter("@Address", txtAddress.Text),
                        new MySqlParameter("@ApplicantID", applicantId.Value)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                else
                {
                    // Добавление нового абитуриента
                    string query = @"
                        INSERT INTO applicants (FirstName, LastName, Email, Phone, BirthDate, AverageScore, EducationType, Address)
                        VALUES (@FirstName, @LastName, @Email, @Phone, @BirthDate, @AverageScore, @EducationType, @Address)";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@FirstName", txtFirstName.Text),
                        new MySqlParameter("@LastName", txtLastName.Text),
                        new MySqlParameter("@Email", txtEmail.Text),
                        new MySqlParameter("@Phone", txtPhone.Text),
                        new MySqlParameter("@BirthDate", dtpBirthDate.Value),
                        new MySqlParameter("@AverageScore", numAvgScore.Value),
                        new MySqlParameter("@EducationType", cmbEducationType.Text),
                        new MySqlParameter("@Address", txtAddress.Text)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка сохранения абитуриента: " + ex.Message, "Ошибка");
            }
        }

        private void BtnDelete_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Вы уверены, что хотите удалить этого абитуриента?", 
                "Подтверждение удаления", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
            {
                try
                {
                    // Проверяем, есть ли у абитуриента заявки
                    string checkQuery = "SELECT COUNT(*) FROM applications WHERE ApplicantID = @ApplicantID";
                    int applicationsCount = Convert.ToInt32(dbHelper.ExecuteScalar(checkQuery, 
                        new MySqlParameter("@ApplicantID", applicantId.Value)));
                    
                    if (applicationsCount > 0)
                    {
                        MessageBox.Show("Невозможно удалить абитуриента, у которого есть заявки.\n" +
                                      "Сначала удалите все заявки этого абитуриента.", 
                                      "Ошибка", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                    
                    string query = "DELETE FROM applicants WHERE ApplicantID = @ApplicantID";
                    dbHelper.ExecuteNonQuery(query, new MySqlParameter("@ApplicantID", applicantId.Value));
                    
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Ошибка удаления абитуриента: " + ex.Message, "Ошибка");
                }
            }
        }
    }
}