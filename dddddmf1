using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace ApplicantTrackingSystem
{
    public partial class MainForm : Form
    {
        private DatabaseHelper dbHelper;
        private TabControl tabControl1;
        
        private TabPage tabApplicants, tabApplications, tabSpecialties, tabUniversities, tabStatistics;
        private DataGridView dataGridViewApplicants, dataGridViewApplications, dataGridViewSpecialties, 
                          dataGridViewUniversities, dataGridViewStats;
        
        // Элементы для вкладки "Абитуриенты"
        private TextBox txtFirstName, txtLastName, txtEmail, txtPhone, txtAddress;
        private DateTimePicker dtpBirthDate;
        private NumericUpDown numAvgScore;
        private ComboBox cmbEducationType;
        private Button btnAddApplicant;
        
        // Элементы для вкладки "Заявки"
        private ComboBox cmbApplicant, cmbSpecialty, cmbUniversity;
        private DateTimePicker dtpApplicationDate;
        private ComboBox cmbStatus;
        private Button btnAddApplication;
        
        // Элементы для вкладки "Специальности"
        private TextBox txtSpecialtyName, txtSpecialtyCode, txtDescription;
        private NumericUpDown numRequiredScore;
        private Button btnAddSpecialty;
        
        // Элементы для вкладки "ВУЗы"
        private TextBox txtUniversityName, txtUniversityCity, txtUniversityWebsite;
        private Button btnAddUniversity;
        
        // Общие элементы
        private Button btnRefresh, btnLogout;
        private string currentUsername, currentRole, currentFullName;
        
        // Статистика
        private Label lblStatsTotalApplicants, lblStatsTotalApplications, lblStatsPendingApplications, 
                      lblStatsAcceptedApplications, lblStatsAvgScore;

        public MainForm(string username, string role, string fullName)
        {
            currentUsername = username;
            currentRole = role;
            currentFullName = fullName;
            
            InitializeComponent();
            SetupPermissions();
            LoadInitialData();
            AddContextMenus();
        }

        private void InitializeComponent()
        {
            this.Text = $"Учет абитуриентов - {currentFullName} ({currentRole})";
            this.Size = new Size(1200, 700);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Font = new Font("Segoe UI", 9);
            
            CreateHeader();
            CreateTabs();
            CreateRefreshButton();
            
            this.Controls.Add(tabControl1);
            this.Controls.Add(btnRefresh);
        }

        private void CreateHeader()
        {
            Panel header = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1150, 40),
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.FromArgb(240, 240, 240)
            };

            Label lblInfo = new Label
            {
                Text = $"Пользователь: {currentFullName} | Роль: {currentRole} | Время входа: {DateTime.Now:HH:mm:ss}",
                Location = new Point(10, 10),
                Size = new Size(800, 20),
                Font = new Font("Segoe UI", 10, FontStyle.Bold),
                ForeColor = Color.FromArgb(52, 152, 219)
            };

            btnLogout = new Button
            {
                Text = "Выйти",
                Location = new Point(1050, 5),
                Size = new Size(90, 30),
                BackColor = Color.FromArgb(231, 76, 60),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnLogout.Click += BtnLogout_Click;

            header.Controls.Add(lblInfo);
            header.Controls.Add(btnLogout);
            this.Controls.Add(header);
        }

        private void CreateTabs()
        {
            tabControl1 = new TabControl
            {
                Location = new Point(15, 60),
                Size = new Size(1150, 580),
                Font = new Font("Segoe UI", 9)
            };

            // Создание вкладок
            tabApplicants = CreateApplicantsTab();
            tabApplications = CreateApplicationsTab();
            tabSpecialties = CreateSpecialtiesTab();
            tabUniversities = CreateUniversitiesTab();
            tabStatistics = CreateStatisticsTab();

            tabControl1.TabPages.AddRange(new TabPage[] { 
                tabApplicants, tabApplications, tabSpecialties, tabUniversities, tabStatistics 
            });
        }

        private TabPage CreateApplicantsTab()
        {
            var tab = new TabPage("Абитуриенты");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 100),
                BorderStyle = BorderStyle.FixedSingle
            };

            int x = 10, y = 15;
            
            // Имя
            Label lblFirstName = new Label { Text = "Имя:", Location = new Point(x, y), Size = new Size(40, 20) };
            txtFirstName = new TextBox { Location = new Point(x + 45, y - 3), Size = new Size(100, 23) };
            x += 160;
            
            // Фамилия
            Label lblLastName = new Label { Text = "Фамилия:", Location = new Point(x, y), Size = new Size(60, 20) };
            txtLastName = new TextBox { Location = new Point(x + 65, y - 3), Size = new Size(100, 23) };
            x += 180;
            
            // Email
            Label lblEmail = new Label { Text = "Email:", Location = new Point(x, y), Size = new Size(40, 20) };
            txtEmail = new TextBox { Location = new Point(x + 45, y - 3), Size = new Size(120, 23) };
            x += 175;
            
            // Телефон
            Label lblPhone = new Label { Text = "Телефон:", Location = new Point(x, y), Size = new Size(60, 20) };
            txtPhone = new TextBox { Location = new Point(x + 65, y - 3), Size = new Size(100, 23) };
            
            // Вторая строка
            x = 10; y = 50;
            
            // Дата рождения
            Label lblBirthDate = new Label { Text = "Дата рождения:", Location = new Point(x, y), Size = new Size(100, 20) };
            dtpBirthDate = new DateTimePicker { 
                Location = new Point(x + 105, y - 3), 
                Size = new Size(100, 23),
                Value = new DateTime(2000, 1, 1),
                Format = DateTimePickerFormat.Short
            };
            x += 220;
            
            // Средний балл
            Label lblAvgScore = new Label { Text = "Средний балл:", Location = new Point(x, y), Size = new Size(90, 20) };
            numAvgScore = new NumericUpDown { 
                Location = new Point(x + 95, y - 3), 
                Size = new Size(60, 23),
                Minimum = 0,
                Maximum = 100,
                DecimalPlaces = 2,
                Value = 70
            };
            x += 170;
            
            // Тип образования
            Label lblEducationType = new Label { Text = "Образование:", Location = new Point(x, y), Size = new Size(90, 20) };
            cmbEducationType = new ComboBox { 
                Location = new Point(x + 95, y - 3), 
                Size = new Size(120, 23),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            cmbEducationType.Items.AddRange(new string[] { "Среднее", "Среднее специальное", "Неоконченное высшее", "Высшее" });
            cmbEducationType.SelectedIndex = 0;
            x += 230;
            
            // Адрес
            Label lblAddress = new Label { Text = "Адрес:", Location = new Point(x, y), Size = new Size(50, 20) };
            txtAddress = new TextBox { Location = new Point(x + 55, y - 3), Size = new Size(150, 23) };
            
            // Кнопка добавления
            btnAddApplicant = new Button
            {
                Location = new Point(950, 35),
                Size = new Size(120, 30),
                Text = "Добавить абитуриента",
                BackColor = Color.FromArgb(46, 204, 113),
                ForeColor = Color.White
            };
            btnAddApplicant.Click += BtnAddApplicant_Click;
            
            // Добавление элементов на панель
            inputPanel.Controls.AddRange(new Control[] {
                lblFirstName, txtFirstName, lblLastName, txtLastName, lblEmail, txtEmail,
                lblPhone, txtPhone, lblBirthDate, dtpBirthDate, lblAvgScore, numAvgScore,
                lblEducationType, cmbEducationType, lblAddress, txtAddress, btnAddApplicant
            });

            // DataGridView для абитуриентов
            dataGridViewApplicants = new DataGridView
            {
                Location = new Point(10, 120),
                Size = new Size(1110, 440),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewApplicants);
            return tab;
        }

        private TabPage CreateApplicationsTab()
        {
            var tab = new TabPage("Заявки");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 80),
                BorderStyle = BorderStyle.FixedSingle
            };

            int x = 10, y = 15;
            
            // Абитуриент
            Label lblApplicant = new Label { Text = "Абитуриент:", Location = new Point(x, y), Size = new Size(80, 20) };
            cmbApplicant = new ComboBox { 
                Location = new Point(x + 85, y - 3), 
                Size = new Size(150, 23),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            x += 250;
            
            // Специальность
            Label lblSpecialty = new Label { Text = "Специальность:", Location = new Point(x, y), Size = new Size(100, 20) };
            cmbSpecialty = new ComboBox { 
                Location = new Point(x + 105, y - 3), 
                Size = new Size(180, 23),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            x += 300;
            
            // ВУЗ
            Label lblUniversity = new Label { Text = "ВУЗ:", Location = new Point(x, y), Size = new Size(40, 20) };
            cmbUniversity = new ComboBox { 
                Location = new Point(x + 45, y - 3), 
                Size = new Size(150, 23),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            
            // Вторая строка
            x = 10; y = 50;
            
            // Дата подачи
            Label lblApplicationDate = new Label { Text = "Дата подачи:", Location = new Point(x, y), Size = new Size(80, 20) };
            dtpApplicationDate = new DateTimePicker { 
                Location = new Point(x + 85, y - 3), 
                Size = new Size(100, 23),
                Value = DateTime.Now,
                Format = DateTimePickerFormat.Short
            };
            x += 200;
            
            // Статус
            Label lblStatus = new Label { Text = "Статус:", Location = new Point(x, y), Size = new Size(50, 20) };
            cmbStatus = new ComboBox { 
                Location = new Point(x + 55, y - 3), 
                Size = new Size(120, 23),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            cmbStatus.Items.AddRange(new string[] { "Подана", "Рассмотрение", "Принята", "Отклонена", "Ожидание" });
            cmbStatus.SelectedIndex = 0;
            
            // Кнопка добавления
            btnAddApplication = new Button
            {
                Location = new Point(850, 15),
                Size = new Size(120, 40),
                Text = "Добавить заявку",
                BackColor = Color.FromArgb(52, 152, 219),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnAddApplication.Click += BtnAddApplication_Click;
            
            // Добавление элементов на панель
            inputPanel.Controls.AddRange(new Control[] {
                lblApplicant, cmbApplicant, lblSpecialty, cmbSpecialty, lblUniversity, cmbUniversity,
                lblApplicationDate, dtpApplicationDate, lblStatus, cmbStatus, btnAddApplication
            });

            // DataGridView для заявок
            dataGridViewApplications = new DataGridView
            {
                Location = new Point(10, 100),
                Size = new Size(1110, 460),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewApplications);
            return tab;
        }

        private TabPage CreateSpecialtiesTab()
        {
            var tab = new TabPage("Специальности");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 80),
                BorderStyle = BorderStyle.FixedSingle
            };

            int x = 10, y = 15;
            
            // Название специальности
            Label lblSpecialtyName = new Label { Text = "Название:", Location = new Point(x, y), Size = new Size(70, 20) };
            txtSpecialtyName = new TextBox { Location = new Point(x + 75, y - 3), Size = new Size(150, 23) };
            x += 240;
            
            // Код специальности
            Label lblSpecialtyCode = new Label { Text = "Код:", Location = new Point(x, y), Size = new Size(40, 20) };
            txtSpecialtyCode = new TextBox { Location = new Point(x + 45, y - 3), Size = new Size(80, 23) };
            x += 140;
            
            // Проходной балл
            Label lblRequiredScore = new Label { Text = "Проходной балл:", Location = new Point(x, y), Size = new Size(110, 20) };
            numRequiredScore = new NumericUpDown { 
                Location = new Point(x + 115, y - 3), 
                Size = new Size(60, 23),
                Minimum = 0,
                Maximum = 100,
                Value = 65
            };
            
            // Вторая строка
            x = 10; y = 50;
            
            // Описание
            Label lblDescription = new Label { Text = "Описание:", Location = new Point(x, y), Size = new Size(70, 20) };
            txtDescription = new TextBox { 
                Location = new Point(x + 75, y - 3), 
                Size = new Size(300, 23)
            };
            
            // Кнопка добавления
            btnAddSpecialty = new Button
            {
                Location = new Point(850, 15),
                Size = new Size(120, 40),
                Text = "Добавить специальность",
                BackColor = Color.FromArgb(155, 89, 182),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnAddSpecialty.Click += BtnAddSpecialty_Click;
            
            // Добавление элементов на панель
            inputPanel.Controls.AddRange(new Control[] {
                lblSpecialtyName, txtSpecialtyName, lblSpecialtyCode, txtSpecialtyCode,
                lblRequiredScore, numRequiredScore, lblDescription, txtDescription, btnAddSpecialty
            });

            // DataGridView для специальностей
            dataGridViewSpecialties = new DataGridView
            {
                Location = new Point(10, 100),
                Size = new Size(1110, 460),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewSpecialties);
            return tab;
        }

        private TabPage CreateUniversitiesTab()
        {
            var tab = new TabPage("ВУЗы");
            
            Panel inputPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 80),
                BorderStyle = BorderStyle.FixedSingle
            };

            int x = 10, y = 15;
            
            // Название ВУЗа
            Label lblUniversityName = new Label { Text = "Название ВУЗа:", Location = new Point(x, y), Size = new Size(100, 20) };
            txtUniversityName = new TextBox { Location = new Point(x + 105, y - 3), Size = new Size(200, 23) };
            x += 320;
            
            // Город
            Label lblUniversityCity = new Label { Text = "Город:", Location = new Point(x, y), Size = new Size(50, 20) };
            txtUniversityCity = new TextBox { Location = new Point(x + 55, y - 3), Size = new Size(120, 23) };
            x += 190;
            
            // Веб-сайт
            Label lblUniversityWebsite = new Label { Text = "Веб-сайт:", Location = new Point(x, y), Size = new Size(70, 20) };
            txtUniversityWebsite = new TextBox { Location = new Point(x + 75, y - 3), Size = new Size(150, 23) };
            
            // Кнопка добавления
            btnAddUniversity = new Button
            {
                Location = new Point(850, 15),
                Size = new Size(120, 40),
                Text = "Добавить ВУЗ",
                BackColor = Color.FromArgb(241, 196, 15),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnAddUniversity.Click += BtnAddUniversity_Click;
            
            // Добавление элементов на панель
            inputPanel.Controls.AddRange(new Control[] {
                lblUniversityName, txtUniversityName, lblUniversityCity, txtUniversityCity,
                lblUniversityWebsite, txtUniversityWebsite, btnAddUniversity
            });

            // DataGridView для ВУЗов
            dataGridViewUniversities = new DataGridView
            {
                Location = new Point(10, 100),
                Size = new Size(1110, 460),
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect
            };

            tab.Controls.Add(inputPanel);
            tab.Controls.Add(dataGridViewUniversities);
            return tab;
        }

        private TabPage CreateStatisticsTab()
        {
            var tab = new TabPage("Статистика");
            
            Panel statsPanel = new Panel
            {
                Location = new Point(10, 10),
                Size = new Size(1110, 150),
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.FromArgb(240, 240, 240)
            };

            // Заголовок
            Label lblTitle = new Label
            {
                Text = "Статистика приема абитуриентов",
                Font = new Font("Segoe UI", 14, FontStyle.Bold),
                Location = new Point(10, 10),
                Size = new Size(400, 30),
                ForeColor = Color.FromArgb(52, 73, 94)
            };

            // Статистика в 2 колонки
            int x1 = 20, x2 = 300;
            int y = 50;

            // Колонка 1
            Label lblTotalApplicants = new Label
            {
                Text = "Всего абитуриентов:",
                Location = new Point(x1, y),
                Size = new Size(150, 25),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            lblStatsTotalApplicants = new Label
            {
                Text = "0",
                Location = new Point(x1 + 160, y),
                Size = new Size(100, 25),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.Blue
            };
            y += 30;

            Label lblTotalApplications = new Label
            {
                Text = "Всего заявок:",
                Location = new Point(x1, y),
                Size = new Size(150, 25),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            lblStatsTotalApplications = new Label
            {
                Text = "0",
                Location = new Point(x1 + 160, y),
                Size = new Size(100, 25),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.Green
            };
            y += 30;

            Label lblAvgScore = new Label
            {
                Text = "Средний балл:",
                Location = new Point(x1, y),
                Size = new Size(150, 25),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            lblStatsAvgScore = new Label
            {
                Text = "0.00",
                Location = new Point(x1 + 160, y),
                Size = new Size(100, 25),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.Orange
            };

            // Колонка 2
            y = 50;

            Label lblPendingApplications = new Label
            {
                Text = "Заявок на рассмотрении:",
                Location = new Point(x2, y),
                Size = new Size(180, 25),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            lblStatsPendingApplications = new Label
            {
                Text = "0",
                Location = new Point(x2 + 185, y),
                Size = new Size(100, 25),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.OrangeRed
            };
            y += 30;

            Label lblAcceptedApplications = new Label
            {
                Text = "Принятых заявок:",
                Location = new Point(x2, y),
                Size = new Size(150, 25),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            lblStatsAcceptedApplications = new Label
            {
                Text = "0",
                Location = new Point(x2 + 155, y),
                Size = new Size(100, 25),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.Green
            };

            // Кнопка обновления статистики
            Button btnUpdateStats = new Button
            {
                Text = "Обновить статистику",
                Location = new Point(800, 60),
                Size = new Size(150, 40),
                BackColor = Color.FromArgb(52, 152, 219),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnUpdateStats.Click += BtnUpdateStats_Click;

            // Добавление элементов на панель
            statsPanel.Controls.Add(lblTitle);
            statsPanel.Controls.Add(lblTotalApplicants);
            statsPanel.Controls.Add(lblStatsTotalApplicants);
            statsPanel.Controls.Add(lblTotalApplications);
            statsPanel.Controls.Add(lblStatsTotalApplications);
            statsPanel.Controls.Add(lblAvgScore);
            statsPanel.Controls.Add(lblStatsAvgScore);
            statsPanel.Controls.Add(lblPendingApplications);
            statsPanel.Controls.Add(lblStatsPendingApplications);
            statsPanel.Controls.Add(lblAcceptedApplications);
            statsPanel.Controls.Add(lblStatsAcceptedApplications);
            statsPanel.Controls.Add(btnUpdateStats);

            // Таблица статистики по специальностям