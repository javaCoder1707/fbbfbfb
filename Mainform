using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace AutoSalonApp
{
    public partial class MainForm : Form
    {
        private DatabaseHelper dbHelper;
        private TabControl tabControl1;
        
        private TabPage tabBrands;
        private TabPage tabCars;
        private TabPage tabEmployees;
        private TabPage tabCustomers;
        private TabPage tabSales;
        private TabPage tabStatistics;
        private TabPage tabUsers;
        
        private DataGridView dataGridViewBrands;
        private DataGridView dataGridViewCars;
        private DataGridView dataGridViewEmployees;
        private DataGridView dataGridViewCustomers;
        private DataGridView dataGridViewSales;
        private DataGridView dataGridViewUsers;
        
        private TextBox txtBrandName;
        private TextBox txtCountry;
        private Button btnAddBrand;
        
        private ComboBox cmbBrands;
        private TextBox txtModel;
        private TextBox txtColor;
        private TextBox txtVIN;
        private NumericUpDown numYear;
        private NumericUpDown numPrice;
        private Button btnAddCar;
        private Button btnSearchCars;
        private TextBox txtSearchCar;
        
        private ComboBox cmbCar;
        private ComboBox cmbCustomer;
        private ComboBox cmbEmployee;
        private DateTimePicker dtpSaleDate;
        private NumericUpDown numSalePrice;
        private Button btnAddSale;
        
        private Button btnAddUser;
        private Button btnEditUser;
        private Button btnDeleteUser;
        private Button btnRefresh;
        private Button btnLogout;
        
        private Label lblUserInfo;
        private string currentUsername;
        private string currentRole;
        private string currentFullName;
        
        private Label lblStatsTotalCars;
        private Label lblStatsAvailableCars;
        private Label lblStatsTotalSales;
        private Label lblStatsTotalRevenue;

        public MainForm(string username, string role, string fullName)
        {
            currentUsername = username;
            currentRole = role;
            currentFullName = fullName;
            
            InitializeComponent();
            try
            {
                dbHelper = new DatabaseHelper();
                LoadComboBoxData();
                RefreshAllData();
                SetupPermissions();
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();
            this.Text = $"–ê–≤—Ç–æ—Å–∞–ª–æ–Ω - {currentFullName} ({currentRole})";
            this.Size = new Size(1300, 800);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Font = new Font("Segoe UI", 9);
            this.FormClosing += MainForm_FormClosing;

            CreateUserInfoPanel();
            CreateTabControl();
            CreateBrandsTab();
            CreateCarsTab();
            CreateEmployeesTab();
            CreateCustomersTab();
            CreateSalesTab();
            CreateStatisticsTab();
            
            if (currentRole == "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
            {
                CreateUsersTab();
            }
            
            CreateRefreshButton();

            this.Controls.Add(lblUserInfo);
            this.Controls.Add(tabControl1);
            this.Controls.Add(btnRefresh);
            this.Controls.Add(btnLogout);
            this.ResumeLayout(false);
        }

        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (MessageBox.Show("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?", "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞",
                MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
            {
                e.Cancel = true;
            }
        }

        private void CreateUserInfoPanel()
        {
            Panel userPanel = new Panel();
            userPanel.Location = new Point(10, 10);
            userPanel.Size = new Size(1260, 40);
            userPanel.BorderStyle = BorderStyle.FixedSingle;
            userPanel.BackColor = Color.FromArgb(240, 240, 240);

            lblUserInfo = new Label();
            lblUserInfo.Text = $"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {currentFullName} | –†–æ–ª—å: {currentRole} | –í—Ä–µ–º—è –≤—Ö–æ–¥–∞: {DateTime.Now:HH:mm:ss}";
            lblUserInfo.Location = new Point(10, 10);
            lblUserInfo.Size = new Size(800, 20);
            lblUserInfo.Font = new Font("Segoe UI", 10, FontStyle.Bold);
            lblUserInfo.ForeColor = Color.FromArgb(52, 152, 219);

            btnLogout = new Button();
            btnLogout.Text = "–í—ã–π—Ç–∏";
            btnLogout.Location = new Point(1150, 5);
            btnLogout.Size = new Size(100, 30);
            btnLogout.BackColor = Color.FromArgb(231, 76, 60);
            btnLogout.ForeColor = Color.White;
            btnLogout.Font = new Font("Segoe UI", 9, FontStyle.Bold);
            btnLogout.Click += BtnLogout_Click;

            userPanel.Controls.Add(lblUserInfo);
            userPanel.Controls.Add(btnLogout);
            
            this.Controls.Add(userPanel);
        }

        private void BtnLogout_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?", "–í—ã—Ö–æ–¥",
                MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                this.Close();
            }
        }

        private void SetupPermissions()
        {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            switch (currentRole)
            {
                case "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä":
                    // –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–∫–ª–∞–¥–∫–∞–º
                    break;
                    
                case "–ú–µ–Ω–µ–¥–∂–µ—Ä":
                    // –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                    tabControl1.TabPages.Remove(tabUsers);
                    break;
                    
                case "–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç":
                    // –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∞–≤—Ç–æ –∏ –æ—Ñ–æ—Ä–º–ª—è—Ç—å –ø—Ä–æ–¥–∞–∂–∏
                    tabControl1.TabPages.Remove(tabBrands);
                    tabControl1.TabPages.Remove(tabEmployees);
                    tabControl1.TabPages.Remove(tabCustomers);
                    tabControl1.TabPages.Remove(tabStatistics);
                    tabControl1.TabPages.Remove(tabUsers);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
                    if (tabCars.Controls.Count > 0)
                    {
                        Panel carsPanel = (Panel)tabCars.Controls[0];
                        foreach (Control ctrl in carsPanel.Controls)
                        {
                            if (ctrl is Button)
                            {
                                ctrl.Enabled = false;
                            }
                        }
                    }
                    break;
            }
        }

        private void CreateTabControl()
        {
            tabControl1 = new TabControl();
            tabControl1.Location = new Point(15, 60);
            tabControl1.Size = new Size(1250, 650);
            tabControl1.Font = new Font("Segoe UI", 9);

            tabBrands = new TabPage("–ú–∞—Ä–∫–∏");
            tabCars = new TabPage("–ê–≤—Ç–æ–º–æ–±–∏–ª–∏");
            tabEmployees = new TabPage("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏");
            tabCustomers = new TabPage("–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏");
            tabSales = new TabPage("–ü—Ä–æ–¥–∞–∂–∏");
            tabStatistics = new TabPage("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");

            tabControl1.Controls.Add(tabBrands);
            tabControl1.Controls.Add(tabCars);
            tabControl1.Controls.Add(tabEmployees);
            tabControl1.Controls.Add(tabCustomers);
            tabControl1.Controls.Add(tabSales);
            tabControl1.Controls.Add(tabStatistics);
        }

        private void CreateBrandsTab()
        {
            Panel inputPanel = new Panel();
            inputPanel.Location = new Point(10, 10);
            inputPanel.Size = new Size(1200, 60);
            inputPanel.BorderStyle = BorderStyle.FixedSingle;

            Label lblBrandName = new Label();
            lblBrandName.Text = "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–∏:";
            lblBrandName.Location = new Point(10, 20);
            lblBrandName.Size = new Size(100, 20);

            Label lblCountry = new Label();
            lblCountry.Text = "–°—Ç—Ä–∞–Ω–∞:";
            lblCountry.Location = new Point(220, 20);
            lblCountry.Size = new Size(50, 20);

            txtBrandName = new TextBox();
            txtBrandName.Location = new Point(115, 17);
            txtBrandName.Size = new Size(100, 23);

            txtCountry = new TextBox();
            txtCountry.Location = new Point(275, 17);
            txtCountry.Size = new Size(100, 23);

            btnAddBrand = new Button();
            btnAddBrand.Location = new Point(390, 15);
            btnAddBrand.Size = new Size(100, 27);
            btnAddBrand.Text = "–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫—É";
            btnAddBrand.Click += BtnAddBrand_Click;

            inputPanel.Controls.Add(lblBrandName);
            inputPanel.Controls.Add(lblCountry);
            inputPanel.Controls.Add(txtBrandName);
            inputPanel.Controls.Add(txtCountry);
            inputPanel.Controls.Add(btnAddBrand);

            dataGridViewBrands = new DataGridView();
            dataGridViewBrands.Location = new Point(10, 80);
            dataGridViewBrands.Size = new Size(1200, 530);
            dataGridViewBrands.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            dataGridViewBrands.SelectionMode = DataGridViewSelectionMode.FullRowSelect;

            tabBrands.Controls.Add(inputPanel);
            tabBrands.Controls.Add(dataGridViewBrands);
        }

        private void CreateCarsTab()
        {
            Panel inputPanel = new Panel();
            inputPanel.Location = new Point(10, 10);
            inputPanel.Size = new Size(1200, 80);
            inputPanel.BorderStyle = BorderStyle.FixedSingle;

            Label lblBrand = new Label();
            lblBrand.Text = "–ú–∞—Ä–∫–∞:";
            lblBrand.Location = new Point(10, 15);
            lblBrand.Size = new Size(45, 20);

            Label lblModel = new Label();
            lblModel.Text = "–ú–æ–¥–µ–ª—å:";
            lblModel.Location = new Point(10, 45);
            lblModel.Size = new Size(45, 20);

            Label lblYear = new Label();
            lblYear.Text = "–ì–æ–¥:";
            lblYear.Location = new Point(180, 15);
            lblYear.Size = new Size(35, 20);

            Label lblColor = new Label();
            lblColor.Text = "–¶–≤–µ—Ç:";
            lblColor.Location = new Point(180, 45);
            lblColor.Size = new Size(40, 20);

            Label lblPrice = new Label();
            lblPrice.Text = "–¶–µ–Ω–∞:";
            lblPrice.Location = new Point(350, 15);
            lblPrice.Size = new Size(40, 20);

            Label lblVIN = new Label();
            lblVIN.Text = "VIN:";
            lblVIN.Location = new Point(350, 45);
            lblVIN.Size = new Size(35, 20);

            cmbBrands = new ComboBox();
            cmbBrands.Location = new Point(60, 12);
            cmbBrands.Size = new Size(110, 23);
            cmbBrands.DropDownStyle = ComboBoxStyle.DropDownList;

            txtModel = new TextBox();
            txtModel.Location = new Point(60, 42);
            txtModel.Size = new Size(110, 23);

            numYear = new NumericUpDown();
            numYear.Location = new Point(220, 12);
            numYear.Size = new Size(60, 23);
            numYear.Minimum = 2000;
            numYear.Maximum = 2030;
            numYear.Value = 2024;

            txtColor = new TextBox();
            txtColor.Location = new Point(220, 42);
            txtColor.Size = new Size(110, 23);

            numPrice = new NumericUpDown();
            numPrice.Location = new Point(395, 12);
            numPrice.Size = new Size(90, 23);
            numPrice.Minimum = 0;
            numPrice.Maximum = 100000000;
            numPrice.Value = 1000000;

            txtVIN = new TextBox();
            txtVIN.Location = new Point(395, 42);
            txtVIN.Size = new Size(120, 23);

            btnAddCar = new Button();
            btnAddCar.Location = new Point(530, 15);
            btnAddCar.Size = new Size(100, 50);
            btnAddCar.Text = "–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ";
            btnAddCar.Click += BtnAddCar_Click;

            Panel searchPanel = new Panel();
            searchPanel.Location = new Point(650, 15);
            searchPanel.Size = new Size(400, 50);

            Label lblSearch = new Label();
            lblSearch.Text = "–ü–æ–∏—Å–∫:";
            lblSearch.Location = new Point(5, 17);
            lblSearch.Size = new Size(50, 20);

            txtSearchCar = new TextBox();
            txtSearchCar.Location = new Point(60, 14);
            txtSearchCar.Size = new Size(200, 23);

            btnSearchCars = new Button();
            btnSearchCars.Location = new Point(270, 14);
            btnSearchCars.Size = new Size(80, 25);
            btnSearchCars.Text = "–ù–∞–π—Ç–∏";
            btnSearchCars.Click += BtnSearchCars_Click;

            Button btnClearSearch = new Button();
            btnClearSearch.Location = new Point(360, 14);
            btnClearSearch.Size = new Size(80, 25);
            btnClearSearch.Text = "–°–±—Ä–æ—Å";
            btnClearSearch.Click += (s, e) => {
                txtSearchCar.Text = "";
                LoadCars();
            };

            searchPanel.Controls.Add(lblSearch);
            searchPanel.Controls.Add(txtSearchCar);
            searchPanel.Controls.Add(btnSearchCars);
            searchPanel.ControlsinputPanel.Controls.Add(lblBrand);
        inputPanel.Controls.Add(lblModel);
        inputPanel.Controls.Add(lblYear);
        inputPanel.Controls.Add(lblColor);
        inputPanel.Controls.Add(lblPrice);
        inputPanel.Controls.Add(lblVIN);
        inputPanel.Controls.Add(cmbBrands);
        inputPanel.Controls.Add(txtModel);
        inputPanel.Controls.Add(numYear);
        inputPanel.Controls.Add(txtColor);
        inputPanel.Controls.Add(numPrice);
        inputPanel.Controls.Add(txtVIN);
        inputPanel.Controls.Add(btnAddCar);
        inputPanel.Controls.Add(searchPanel);

        dataGridViewCars = new DataGridView();
        dataGridViewCars.Location = new Point(10, 100);
        dataGridViewCars.Size = new Size(1200, 510);
        dataGridViewCars.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridViewCars.SelectionMode = DataGridViewSelectionMode.FullRowSelect;

        tabCars.Controls.Add(inputPanel);
        tabCars.Controls.Add(dataGridViewCars);
    }

    private void CreateEmployeesTab()
    {
        Panel inputPanel = new Panel();
        inputPanel.Location = new Point(10, 10);
        inputPanel.Size = new Size(1200, 60);
        inputPanel.BorderStyle = BorderStyle.FixedSingle;

        Label lblAddEmployee = new Label();
        lblAddEmployee.Text = "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º";
        lblAddEmployee.Location = new Point(10, 20);
        lblAddEmployee.Size = new Size(500, 20);
        lblAddEmployee.Font = new Font("Segoe UI", 9, FontStyle.Italic);
        lblAddEmployee.ForeColor = Color.Gray;

        inputPanel.Controls.Add(lblAddEmployee);

        dataGridViewEmployees = new DataGridView();
        dataGridViewEmployees.Location = new Point(10, 80);
        dataGridViewEmployees.Size = new Size(1200, 530);
        dataGridViewEmployees.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridViewEmployees.SelectionMode = DataGridViewSelectionMode.FullRowSelect;

        tabEmployees.Controls.Add(inputPanel);
        tabEmployees.Controls.Add(dataGridViewEmployees);
    }

    private void CreateCustomersTab()
    {
        Panel inputPanel = new Panel();
        inputPanel.Location = new Point(10, 10);
        inputPanel.Size = new Size(1200, 60);
        inputPanel.BorderStyle = BorderStyle.FixedSingle;

        Label lblAddCustomer = new Label();
        lblAddCustomer.Text = "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º";
        lblAddCustomer.Location = new Point(10, 20);
        lblAddCustomer.Size = new Size(600, 20);
        lblAddCustomer.Font = new Font("Segoe UI", 9, FontStyle.Italic);
        lblAddCustomer.ForeColor = Color.Gray;

        inputPanel.Controls.Add(lblAddCustomer);

        dataGridViewCustomers = new DataGridView();
        dataGridViewCustomers.Location = new Point(10, 80);
        dataGridViewCustomers.Size = new Size(1200, 530);
        dataGridViewCustomers.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridViewCustomers.SelectionMode = DataGridViewSelectionMode.FullRowSelect;

        tabCustomers.Controls.Add(inputPanel);
        tabCustomers.Controls.Add(dataGridViewCustomers);
    }

    private void CreateSalesTab()
    {
        Panel inputPanel = new Panel();
        inputPanel.Location = new Point(10, 10);
        inputPanel.Size = new Size(1200, 80);
        inputPanel.BorderStyle = BorderStyle.FixedSingle;

        Label lblCar = new Label();
        lblCar.Text = "–ê–≤—Ç–æ–º–æ–±–∏–ª—å:";
        lblCar.Location = new Point(10, 15);
        lblCar.Size = new Size(70, 20);

        Label lblCustomer = new Label();
        lblCustomer.Text = "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:";
        lblCustomer.Location = new Point(10, 45);
        lblCustomer.Size = new Size(70, 20);

        Label lblEmployee = new Label();
        lblEmployee.Text = "–°–æ—Ç—Ä—É–¥–Ω–∏–∫:";
        lblEmployee.Location = new Point(250, 15);
        lblEmployee.Size = new Size(70, 20);

        Label lblSaleDate = new Label();
        lblSaleDate.Text = "–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏:";
        lblSaleDate.Location = new Point(250, 45);
        lblSaleDate.Size = new Size(80, 20);

        Label lblSalePrice = new Label();
        lblSalePrice.Text = "–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏:";
        lblSalePrice.Location = new Point(490, 15);
        lblSalePrice.Size = new Size(80, 20);

        cmbCar = new ComboBox();
        cmbCar.Location = new Point(85, 12);
        cmbCar.Size = new Size(150, 23);
        cmbCar.DropDownStyle = ComboBoxStyle.DropDownList;

        cmbCustomer = new ComboBox();
        cmbCustomer.Location = new Point(85, 42);
        cmbCustomer.Size = new Size(150, 23);
        cmbCustomer.DropDownStyle = ComboBoxStyle.DropDownList;

        cmbEmployee = new ComboBox();
        cmbEmployee.Location = new Point(325, 12);
        cmbEmployee.Size = new Size(150, 23);
        cmbEmployee.DropDownStyle = ComboBoxStyle.DropDownList;

        dtpSaleDate = new DateTimePicker();
        dtpSaleDate.Location = new Point(335, 42);
        dtpSaleDate.Size = new Size(120, 23);
        dtpSaleDate.Value = DateTime.Now;

        numSalePrice = new NumericUpDown();
        numSalePrice.Location = new Point(575, 12);
        numSalePrice.Size = new Size(100, 23);
        numSalePrice.Minimum = 0;
        numSalePrice.Maximum = 100000000;
        numSalePrice.Value = 1000000;

        btnAddSale = new Button();
        btnAddSale.Location = new Point(690, 15);
        btnAddSale.Size = new Size(120, 40);
        btnAddSale.Text = "–û—Ñ–æ—Ä–º–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É";
        btnAddSale.BackColor = Color.FromArgb(46, 204, 113);
        btnAddSale.ForeColor = Color.White;
        btnAddSale.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnAddSale.Click += BtnAddSale_Click;

        // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ - –∞–≤—Ç–æ-–≤—ã–±–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        if (currentRole == "–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç")
        {
            Button btnAutoSelect = new Button();
            btnAutoSelect.Text = "–í—ã–±—Ä–∞—Ç—å –º–µ–Ω—è";
            btnAutoSelect.Location = new Point(820, 15);
            btnAutoSelect.Size = new Size(100, 40);
            btnAutoSelect.BackColor = Color.FromArgb(52, 152, 219);
            btnAutoSelect.ForeColor = Color.White;
            btnAutoSelect.Font = new Font("Segoe UI", 9, FontStyle.Bold);
            btnAutoSelect.Click += BtnAutoSelect_Click;
            inputPanel.Controls.Add(btnAutoSelect);
        }

        inputPanel.Controls.Add(lblCar);
        inputPanel.Controls.Add(lblCustomer);
        inputPanel.Controls.Add(lblEmployee);
        inputPanel.Controls.Add(lblSaleDate);
        inputPanel.Controls.Add(lblSalePrice);
        inputPanel.Controls.Add(cmbCar);
        inputPanel.Controls.Add(cmbCustomer);
        inputPanel.Controls.Add(cmbEmployee);
        inputPanel.Controls.Add(dtpSaleDate);
        inputPanel.Controls.Add(numSalePrice);
        inputPanel.Controls.Add(btnAddSale);

        dataGridViewSales = new DataGridView();
        dataGridViewSales.Location = new Point(10, 100);
        dataGridViewSales.Size = new Size(1200, 510);
        dataGridViewSales.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridViewSales.SelectionMode = DataGridViewSelectionMode.FullRowSelect;

        tabSales.Controls.Add(inputPanel);
        tabSales.Controls.Add(dataGridViewSales);
    }

    private void CreateStatisticsTab()
    {
        Panel statsPanel = new Panel();
        statsPanel.Location = new Point(10, 10);
        statsPanel.Size = new Size(1200, 150);
        statsPanel.BorderStyle = BorderStyle.FixedSingle;
        statsPanel.BackColor = Color.FromArgb(240, 240, 240);

        Label lblTitle = new Label();
        lblTitle.Text = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞";
        lblTitle.Font = new Font("Segoe UI", 14, FontStyle.Bold);
        lblTitle.Location = new Point(10, 10);
        lblTitle.Size = new Size(400, 30);
        lblTitle.ForeColor = Color.FromArgb(52, 73, 94);

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ 2 –∫–æ–ª–æ–Ω–∫–∏
        int x1 = 20, x2 = 350;
        int y = 50;

        // –ö–æ–ª–æ–Ω–∫–∞ 1
        Label lblTotalCars = new Label();
        lblTotalCars.Text = "–í—Å–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:";
        lblTotalCars.Location = new Point(x1, y);
        lblTotalCars.Size = new Size(150, 25);
        lblTotalCars.Font = new Font("Segoe UI", 10, FontStyle.Bold);

        lblStatsTotalCars = new Label();
        lblStatsTotalCars.Text = "0";
        lblStatsTotalCars.Location = new Point(x1 + 160, y);
        lblStatsTotalCars.Size = new Size(100, 25);
        lblStatsTotalCars.Font = new Font("Segoe UI", 10);
        lblStatsTotalCars.ForeColor = Color.Blue;
        y += 30;

        Label lblAvailableCars = new Label();
        lblAvailableCars.Text = "–ê–≤—Ç–æ –≤ –Ω–∞–ª–∏—á–∏–∏:";
        lblAvailableCars.Location = new Point(x1, y);
        lblAvailableCars.Size = new Size(150, 25);
        lblAvailableCars.Font = new Font("Segoe UI", 10, FontStyle.Bold);

        lblStatsAvailableCars = new Label();
        lblStatsAvailableCars.Text = "0";
        lblStatsAvailableCars.Location = new Point(x1 + 160, y);
        lblStatsAvailableCars.Size = new Size(100, 25);
        lblStatsAvailableCars.Font = new Font("Segoe UI", 10);
        lblStatsAvailableCars.ForeColor = Color.Green;
        y += 30;

        // –ö–æ–ª–æ–Ω–∫–∞ 2
        y = 50;

        Label lblTotalSales = new Label();
        lblTotalSales.Text = "–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂:";
        lblTotalSales.Location = new Point(x2, y);
        lblTotalSales.Size = new Size(150, 25);
        lblTotalSales.Font = new Font("Segoe UI", 10, FontStyle.Bold);

        lblStatsTotalSales = new Label();
        lblStatsTotalSales.Text = "0";
        lblStatsTotalSales.Location = new Point(x2 + 160, y);
        lblStatsTotalSales.Size = new Size(100, 25);
        lblStatsTotalSales.Font = new Font("Segoe UI", 10);
        lblStatsTotalSales.ForeColor = Color.Orange;
        y += 30;

        Label lblTotalRevenue = new Label();
        lblTotalRevenue.Text = "–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:";
        lblTotalRevenue.Location = new Point(x2, y);
        lblTotalRevenue.Size = new Size(150, 25);
        lblTotalRevenue.Font = new Font("Segoe UI", 10, FontStyle.Bold);

        lblStatsTotalRevenue = new Label();
        lblStatsTotalRevenue.Text = "0 —Ä—É–±.";
        lblStatsTotalRevenue.Location = new Point(x2 + 160, y);
        lblStatsTotalRevenue.Size = new Size(200, 25);
        lblStatsTotalRevenue.Font = new Font("Segoe UI", 10);
        lblStatsTotalRevenue.ForeColor = Color.Red;

        // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        Button btnUpdateStats = new Button();
        btnUpdateStats.Text = "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É";
        btnUpdateStats.Location = new Point(800, 60);
        btnUpdateStats.Size = new Size(150, 40);
        btnUpdateStats.BackColor = Color.FromArgb(52, 152, 219);
        btnUpdateStats.ForeColor = Color.White;
        btnUpdateStats.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnUpdateStats.Click += BtnUpdateStats_Click;

        statsPanel.Controls.Add(lblTitle);
        statsPanel.Controls.Add(lblTotalCars);
        statsPanel.Controls.Add(lblStatsTotalCars);
        statsPanel.Controls.Add(lblAvailableCars);
        statsPanel.Controls.Add(lblStatsAvailableCars);
        statsPanel.Controls.Add(lblTotalSales);
        statsPanel.Controls.Add(lblStatsTotalSales);
        statsPanel.Controls.Add(lblTotalRevenue);
        statsPanel.Controls.Add(lblStatsTotalRevenue);
        statsPanel.Controls.Add(btnUpdateStats);

        // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π - DataGridView)
        Label lblSalesChart = new Label();
        lblSalesChart.Text = "–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º:";
        lblSalesChart.Font = new Font("Segoe UI", 12, FontStyle.Bold);
        lblSalesChart.Location = new Point(10, 170);
        lblSalesChart.Size = new Size(300, 30);

        DataGridView dataGridViewStats = new DataGridView();
        dataGridViewStats.Location = new Point(10, 200);
        dataGridViewStats.Size = new Size(1200, 380);
        dataGridViewStats.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridViewStats.ReadOnly = true;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–¥–∞–∂
        LoadSalesStatistics(dataGridViewStats);

        tabStatistics.Controls.Add(statsPanel);
        tabStatistics.Controls.Add(lblSalesChart);
        tabStatistics.Controls.Add(dataGridViewStats);
    }

    private void CreateUsersTab()
    {
        Panel controlPanel = new Panel();
        controlPanel.Location = new Point(10, 10);
        controlPanel.Size = new Size(1200, 50);
        controlPanel.BorderStyle = BorderStyle.FixedSingle;

        btnAddUser = new Button();
        btnAddUser.Text = "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
        btnAddUser.Location = new Point(10, 10);
        btnAddUser.Size = new Size(180, 30);
        btnAddUser.BackColor = Color.FromArgb(46, 204, 113);
        btnAddUser.ForeColor = Color.White;
        btnAddUser.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnAddUser.Click += BtnAddUser_Click;

        btnEditUser = new Button();
        btnEditUser.Text = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        btnEditUser.Location = new Point(200, 10);
        btnEditUser.Size = new Size(150, 30);
        btnEditUser.BackColor = Color.FromArgb(52, 152, 219);
        btnEditUser.ForeColor = Color.White;
        btnEditUser.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnEditUser.Click += BtnEditUser_Click;

        btnDeleteUser = new Button();
        btnDeleteUser.Text = "üóëÔ∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å";
        btnDeleteUser.Location = new Point(360, 10);
        btnDeleteUser.Size = new Size(150, 30);
        btnDeleteUser.BackColor = Color.FromArgb(231, 76, 60);
        btnDeleteUser.ForeColor = Color.White;
        btnDeleteUser.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnDeleteUser.Click += BtnDeleteUser_Click;

        // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        Button btnActivateUser = new Button();
        btnActivateUser.Text = "‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å";
        btnActivateUser.Location = new Point(520, 10);
        btnActivateUser.Size = new Size(150, 30);
        btnActivateUser.BackColor = Color.FromArgb(155, 89, 182);
        btnActivateUser.ForeColor = Color.White;
        btnActivateUser.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnActivateUser.Click += BtnActivateUser_Click;

        controlPanel.Controls.Add(btnAddUser);
        controlPanel.Controls.Add(btnEditUser);
        controlPanel.Controls.Add(btnDeleteUser);
        controlPanel.Controls.Add(btnActivateUser);

        dataGridViewUsers = new DataGridView();
        dataGridViewUsers.Location = new Point(10, 70);
        dataGridViewUsers.Size = new Size(1200, 540);
        dataGridViewUsers.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridViewUsers.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
        dataGridViewUsers.ReadOnly = true;

        tabUsers = new TabPage("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏");
        tabUsers.Controls.Add(controlPanel);
        tabUsers.Controls.Add(dataGridViewUsers);
        
        tabControl1.Controls.Add(tabUsers);
    }

    private void CreateRefreshButton()
    {
        btnRefresh = new Button();
        btnRefresh.Text = "üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ";
        btnRefresh.Location = new Point(15, 720);
        btnRefresh.Size = new Size(120, 35);
        btnRefresh.BackColor = Color.FromArgb(241, 196, 15);
        btnRefresh.ForeColor = Color.White;
        btnRefresh.Font = new Font("Segoe UI", 9, FontStyle.Bold);
        btnRefresh.Click += BtnRefresh_Click;
    }

    private void LoadComboBoxData()
    {
        try
        {
            DataTable brands = dbHelper.ExecuteQuery("SELECT BrandID, BrandName FROM Brands");
            cmbBrands.DataSource = brands;
            cmbBrands.DisplayMember = "BrandName";
            cmbBrands.ValueMember = "BrandID";

            DataTable cars = dbHelper.ExecuteQuery(@"
                SELECT CarID, 
                CONCAT(b.BrandName, ' ', c.Model) as CarInfo 
                FROM Cars c 
                JOIN Brands b ON c.BrandID = b.BrandID 
                WHERE c.InStock = TRUE");
            cmbCar.DataSource = cars;
            cmbCar.DisplayMember = "CarInfo";
            cmbCar.ValueMember = "CarID";

            DataTable customers = dbHelper.ExecuteQuery("SELECT CustomerID, CONCAT(FirstName, ' ', LastName) as FullName FROM Customers");
            cmbCustomer.DataSource = customers;
            cmbCustomer.DisplayMember = "FullName";
            cmbCustomer.ValueMember = "CustomerID";

            DataTable employees = dbHelper.ExecuteQuery("SELECT EmployeeID, CONCAT(FirstName, ' ', LastName) as FullName FROM Employees");
            cmbEmployee.DataSource = employees;
            cmbEmployee.DisplayMember = "FullName";
            cmbEmployee.ValueMember = "EmployeeID";
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ ComboBox: " + ex.Message);
        }
    }

    private void RefreshAllData()
    {
        try
        {
            LoadBrands();
            LoadCars();
            LoadEmployees();
            LoadCustomers();
            LoadSales();
            UpdateStatistics();
            
            if (currentRole == "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
            {
                LoadUsers();
            }
            
            LoadComboBoxData();
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: " + ex.Message);
        }
    }

    private void LoadBrands()
    {
        string query = "SELECT * FROM Brands ORDER BY BrandName";
        DataTable dt = dbHelper.ExecuteQuery(query);
        dataGridViewBrands.DataSource = dt;
    }

    private void LoadCars()
    {
        string query = @"
            SELECT 
                c.CarID as 'ID',
                b.BrandName as '–ú–∞—Ä–∫–∞',
                c.Model as '–ú–æ–¥–µ–ª—å',
                c.Year as '–ì–æ–¥',
                c.Color as '–¶–≤–µ—Ç', 
                FORMAT(c.Price, 0) as '–¶–µ–Ω–∞',
                c.VIN as 'VIN-–∫–æ–¥',
                CASE WHEN c.InStock THEN '–í –Ω–∞–ª–∏—á–∏–∏' ELSE '–ü—Ä–æ–¥–∞–Ω–æ' END as '–°—Ç–∞—Ç—É—Å'
            FROM Cars c 
            JOIN Brands b ON c.BrandID = b.BrandID
            ORDER BY b.BrandName, c.Model";
        DataTable dt = dbHelper.ExecuteQuery(query);
        dataGridViewCars.DataSource = dt;
    }

    private void LoadEmployees()
    {
        string query = @"
            SELECT 
                EmployeeID as 'ID',
                FirstName as '–ò–º—è',
                LastName as '–§–∞–º–∏–ª–∏—è',
                Position as '–î–æ–ª–∂–Ω–æ—Å—Ç—å',
                Phone as '–¢–µ–ª–µ—Ñ–æ–Ω',
                DATE_FORMAT(HireDate, '%d.%m.%Y') as '–î–∞—Ç–∞ –Ω–∞–π–º–∞'
            FROM Employees 
            ORDER BY LastName, FirstName";
        DataTable dt = dbHelper.ExecuteQuery(query);
        dataGridViewEmployees.DataSource = dt;
    }

    private void LoadCustomers()
    {
        string query = @"
            SELECT 
                CustomerID as 'ID',
                FirstName as '–ò–º—è',
                LastName as '–§–∞–º–∏–ª–∏—è',
                Email as 'Email',
                Phone as '–¢–µ–ª–µ—Ñ–æ–Ω',
                Address as '–ê–¥—Ä–µ—Å'
            FROM Customers 
            ORDER BY LastName, FirstName";
        DataTable dt = dbHelper.ExecuteQuery(query);
        dataGridViewCustomers.DataSource = dt;
    }

    private void LoadSales()
    {
        string query = @"
            SELECT 
                s.SaleID as 'ID',
                b.BrandName as '–ú–∞—Ä–∫–∞',
                c.Model as '–ú–æ–¥–µ–ª—å',
                CONCAT(cust.FirstName, ' ', cust.LastName) as '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å',
                CONCAT(emp.FirstName, ' ', emp.LastName) as '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
                DATE_FORMAT(s.SaleDate, '%d.%m.%Y') as '–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏',
                FORMAT(s.SalePrice, 0) as '–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏'
            FROM Sales s
            JOIN Cars c ON s.CarID = c.CarID
            JOIN Brands b ON c.BrandID = b.BrandID
            JOIN Customers cust ON s.CustomerID = cust.CustomerID
            JOIN Employees emp ON s.EmployeeID = emp.EmployeeID
            ORDER BY s.SaleDate DESC";
        DataTable dt = dbHelper.ExecuteQuery(query);
        dataGridViewSales.DataSource = dt;
    }

    private void LoadUsers()
    {
        if (currentRole == "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
        {
            string query = @"
                SELECT 
                    id as 'ID',
                    username as '–õ–æ–≥–∏–Ω',
                    full_name as '–§–ò–û',
                    email as 'Email',
                    role as '–†–æ–ª—å',
                    DATE_FORMAT(created_at, '%d.%m.%Y %H:%i') as '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
                    CASE WHEN is_active THEN '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' ELSE '‚ùå –ù–µ –∞–∫—Ç–∏–≤–µ–Ω' END as '–°—Ç–∞—Ç—É—Å'
                FROM users
                ORDER BY role, username";
            DataTable dt = dbHelper.ExecuteQuery(query);
            dataGridViewUsers.DataSource = dt;
        }
    }

    private void UpdateStatistics()
    {
        try
        {
            // –í—Å–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
            string totalCarsQuery = "SELECT COUNT(*) FROM Cars";
            object totalCars = dbHelper.ExecuteScalar(totalCarsQuery);
            lblStatsTotalCars.Text = totalCars?.ToString() ?? "0";

            // –ê–≤—Ç–æ –≤ –Ω–∞–ª–∏—á–∏–∏
            string availableCarsQuery = "SELECT COUNT(*) FROM Cars WHERE InStock = TRUE";
            object availableCars = dbHelper.ExecuteScalar(availableCarsQuery);
            lblStatsAvailableCars.Text = availableCars?.ToString() ?? "0";

            // –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂
            string totalSalesQuery = "SELECT COUNT(*) FROM Sales";
            object totalSales = dbHelper.ExecuteScalar(totalSalesQuery);
            lblStatsTotalSales.Text = totalSales?.ToString() ?? "0";

            // –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
            string totalRevenueQuery = "SELECT SUM(SalePrice) FROM Sales";
            object totalRevenue = dbHelper.ExecuteScalar(totalRevenueQuery);
            if (totalRevenue != DBNull.Value && totalRevenue != null)
            {
                decimal revenue = Convert.ToDecimal(totalRevenue);
                lblStatsTotalRevenue.Text = $"{revenue:N0} —Ä—É–±.";
            }
            else
            {
                lblStatsTotalRevenue.Text = "0 —Ä—É–±.";
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: " + ex.Message);
        }
    }

    private void LoadSalesStatistics(DataGridView dataGridView)
    {
        try
        {
            string query = @"
                SELECT 
                    DATE_FORMAT(SaleDate, '%Y-%m') as '–ú–µ—Å—è—Ü',
                    COUNT(*) as '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂',
                    SUM(SalePrice) as '–û–±—â–∞—è —Å—É–º–º–∞',
                    AVG(SalePrice) as '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫'
                FROM Sales 
                GROUP BY DATE_FORMAT(SaleDate, '%Y-%m')
                ORDER BY DATE_FORMAT(SaleDate, '%Y-%m') DESC";
            
            DataTable dt = dbHelper.ExecuteQuery(query);
            dataGridView.DataSource = dt;
        }
        catch (Exception ex)
        {
            Console.WriteLine("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: " + ex.Message);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    private void BtnAddBrand_Click(object sender, EventArgs e)
    {
        if (currentRole != "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" && currentRole != "–ú–µ–Ω–µ–¥–∂–µ—Ä")
        {
            MessageBox.Show("–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º!", "–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞");
            return;
        }

        try
        {
            if (string.IsNullOrWhiteSpace(txtBrandName.Text))
            {
                MessageBox.Show("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–∏!");
                return;
            }

            string query = "INSERT INTO Brands (BrandName, Country) VALUES (@BrandName, @Country)";
            MySqlParameter[] parameters = {
                new MySqlParameter("@BrandName", txtBrandName.Text),
                new MySqlParameter("@Country", txtCountry.Text)
            };
            
            dbHelper.ExecuteNonQuery(query, parameters);
            LoadBrands();
            LoadComboBoxData();
            txtBrandName.Clear();
            txtCountry.Clear();
            MessageBox.Show("–ú–∞—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!", "–£—Å–ø–µ—Ö");
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
        }
    }

    private void BtnAddCar_Click(object sender, EventArgs e)
    {
        if (currentRole != "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" && currentRole != "–ú–µ–Ω–µ–¥–∂–µ—Ä")
        {
            MessageBox.Show("–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º!", "–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞");
            return;
        }

        try
        {
            if (string.IsNullOrWhiteSpace(txtModel.Text) || string.IsNullOrWhiteSpace(txtVIN.Text))
            {
                MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ VIN!");
                return;
            }

            string query = @"INSERT INTO Cars (BrandID, Model, Year, Color, Price, VIN) 
                           VALUES (@BrandID, @Model, @Year, @Color, @Price, @VIN)";
            MySqlParameter[] parameters = {
                new MySqlParameter("@BrandID", cmbBrands.SelectedValue),
                new MySqlParameter("@Model", txtModel.Text),
                new MySqlParameter("@Year", (int)numYear.Value),
                new MySqlParameter("@Color", txtColor.Text),
                new MySqlParameter("@Price", numPrice.Value),
                new MySqlParameter("@VIN", txtVIN.Text)
            };
            
            dbHelper.ExecuteNonQuery(query, parameters);
            LoadCars();
            LoadComboBoxData();
            ClearCarFields();
            MessageBox.Show("–ê–≤—Ç–æ–º–æ–±–∏–ª—å –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!", "–£—Å–ø–µ—Ö");
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
        }
    }

    private void BtnAddSale_Click(object sender, EventArgs e)
    {
        try
        {
            if (cmbCar.Items.Count == 0)
            {
                MessageBox.Show("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏!", "–û—à–∏–±–∫–∞");
                return;
            }

            if (cmbCar.SelectedValue == null || cmbCustomer.SelectedValue == null || cmbEmployee.SelectedValue == null)
            {
                MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!", "–û—à–∏–±–∫–∞");
                return;
            }

            string query = @"INSERT INTO Sales (CarID, CustomerID, EmployeeID, SaleDate, SalePrice) 
                           VALUES (@CarID, @CustomerID, @EmployeeID, @SaleDate, @SalePrice)";
            MySqlParameter[] parameters = {
                new MySqlParameter("@CarID", cmbCar.SelectedValue),
                new MySqlParameter("@CustomerID", cmbCustomer.SelectedValue),
                new MySqlParameter("@EmployeeID", cmbEmployee.SelectedValue),
                new MySqlParameter("@SaleDate", dtpSaleDate.Value),
                new MySqlParameter("@SalePrice", numSalePrice.Value)
            };
            
            dbHelper.ExecuteNonQuery(query, parameters);
            
            // –ü–æ–º–µ—á–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∫–∞–∫ –ø—Ä–æ–¥–∞–Ω–Ω—ã–π
            string updateCarQuery = "UPDATE Cars SET InStock = FALSE WHERE CarID = @CarID";
            MySqlParameter[] updateParams = {
                new MySqlParameter("@CarID", cmbCar.SelectedValue)
            };
            dbHelper.ExecuteNonQuery(updateCarQuery, updateParams);
            
            LoadSales();
            LoadCars();
            LoadComboBoxData();
            ClearSaleFields();
            UpdateStatistics();
            MessageBox.Show("–ü—Ä–æ–¥–∞–∂–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!", "–£—Å–ø–µ—Ö");
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
        }
    }

    private void BtnAutoSelect_Click(object sender, EventArgs e)
    {
        try
        {
            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            string query = $"SELECT EmployeeID FROM Employees WHERE CONCAT(FirstName, ' ', LastName) LIKE '%{currentFullName}%'";
            DataTable dt = dbHelper.ExecuteQuery(query);
            
            if (dt.Rows.Count > 0)
            {
                cmbEmployee.SelectedValue = dt.Rows[0]["EmployeeID"];
                MessageBox.Show("–í—ã–±—Ä–∞–Ω —Ç–µ–∫—É—â–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: " + currentFullName, "–£—Å–ø–µ—Ö");
            }
            else
            {
                MessageBox.Show("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å –≤–∞—à–∏–º –§–ò–û –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ!", "–û—à–∏–±–∫–∞");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
        }
    }

    private void BtnSearchCars_Click(object sender, EventArgs e)
    {
        try
        {
            string searchTerm = txtSearchCar.Text;
            string query = $@"
                SELECT 
                    c.CarID as 'ID',
                    b.BrandName as '–ú–∞—Ä–∫–∞',
                    c.Model as '–ú–æ–¥–µ–ª—å',
                    c.Year as '–ì–æ–¥',
                    c.Color as '–¶–≤–µ—Ç', 
                    FORMAT(c.Price, 0) as '–¶–µ–Ω–∞',
                    c.VIN as 'VIN-–∫–æ–¥',
                    CASE WHEN c.InStock THEN '–í –Ω–∞–ª–∏—á–∏–∏' ELSE '–ü—Ä–æ–¥–∞–Ω–æ' END as '–°—Ç–∞—Ç—É—Å'
                FROM Cars c 
                JOIN Brands b ON c.BrandID = b.BrandID
                WHERE 
                    b.BrandName LIKE '%{searchTerm}%' OR 
                    c.Model LIKE '%{searchTerm}%' OR 
                    c.Color LIKE '%{searchTerm}%' OR
                    c.VIN LIKE '%{searchTerm}%'
                ORDER BY b.BrandName, c.Model";
            
            DataTable dt = dbHelper.ExecuteQuery(query);
            dataGridViewCars.DataSource = dt;
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + ex.Message, "–û—à–∏–±–∫–∞");
        }
    }

    private void BtnRefresh_Click(object sender, EventArgs e)
    {
        RefreshAllData();
        MessageBox.Show("–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!", "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
    }

    private void BtnUpdateStats_Click(object sender, EventArgs e)
    {
        UpdateStatistics();
        MessageBox.Show("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    private void BtnAddUser_Click(object sender, EventArgs e)
    {
        UserEditForm editForm = new UserEditForm(dbHelper, null, currentRole);
        if (editForm.ShowDialog() == DialogResult.OK)
        {
            LoadUsers();
        }
    }

    private void BtnEditUser_Click(object sender, EventArgs e)
    {
        if (dataGridViewUsers.SelectedRows.Count == 0)
        {
            MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!", "–û—à–∏–±–∫–∞");
            return;
        }

        int userId = Convert.ToInt32(dataGridViewUsers.SelectedRows[0].Cells["ID"].Value);
        
        UserEditForm editForm = new UserEditForm(dbHelper, userId, currentRole);
        if (editForm.ShowDialog() == DialogResult.OK)
        {
            LoadUsers();
        }
    }

    private void BtnDeleteUser_Click(object sender, EventArgs e)
    {
        if (dataGridViewUsers.SelectedRows.Count == 0)
        {
            MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏!", "–û—à–∏–±–∫–∞");
            return;
        }

        int userId = Convert.ToInt32(dataGridViewUsers.SelectedRows[0].Cells["ID"].Value);
        string username = dataGridViewUsers.SelectedRows[0].Cells["–õ–æ–≥–∏–Ω"].Value.ToString();

        if (username == currentUsername)
        {
            MessageBox.Show("–ù–µ–ª—å–∑—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!", "–û—à–∏–±–∫–∞");
            return;
        }

        if (MessageBox.Show($"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '{username}'?", 
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
        {
            try
            {
                string query = "UPDATE users SET is_active = FALSE WHERE id = @id";
                MySqlParameter[] parameters = {
                    new MySqlParameter("@id", userId)
                };
                
                dbHelper.ExecuteNonQuery(query, parameters);
                LoadUsers();
                MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!", "–£—Å–ø–µ—Ö");
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }
    }

    private void BtnActivateUser_Click(object sender, EventArgs e)
    {
        if (dataGridViewUsers.SelectedRows.Count == 0)
        {
            MessageBox.Show("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!", "–û—à–∏–±–∫–∞");
            return;
        }

        int userId = Convert.ToInt32(dataGridViewUsers.SelectedRows[0].Cells["ID"].Value);
        string username = dataGridViewUsers.SelectedRows[0].Cells["–õ–æ–≥–∏–Ω"].Value.ToString();

        if (MessageBox.Show($"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '{username}'?", 
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
        {
            try
            {
                string query = "UPDATE users SET is_active = TRUE WHERE id = @id";
                MySqlParameter[] parameters = {
                    new MySqlParameter("@id", userId)
                };
                
                dbHelper.ExecuteNonQuery(query, parameters);
                LoadUsers();
                MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!", "–£—Å–ø–µ—Ö");
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: " + ex.Message, "–û—à–∏–±–∫–∞");
            }
        }
    }

    private void ClearCarFields()
    {
        txtModel.Clear();
        txtColor.Clear();
        txtVIN.Clear();
        numPrice.Value = 1000000;
        numYear.Value = DateTime.Now.Year;
    }

    private void ClearSaleFields()
    {
        numSalePrice.Value = 1000000;
        dtpSaleDate.Value = DateTime.Now;
    }
}