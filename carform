using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace AutoSalonApp
{
    public class CarForm : Form
    {
        private int? carId;
        private DatabaseHelper dbHelper;
        
        private ComboBox cmbBrand;
        private TextBox txtModel;
        private TextBox txtColor;
        private TextBox txtVIN;
        private NumericUpDown numYear;
        private NumericUpDown numPrice;
        private CheckBox chkInStock;
        private TextBox txtDescription;
        private DateTimePicker dtpArrivalDate;
        
        private Button btnSave;
        private Button btnCancel;
        private Button btnDelete;

        public CarForm(int? id, DatabaseHelper dbHelper)
        {
            this.carId = id;
            this.dbHelper = dbHelper;
            InitializeComponent();
            
            LoadBrands();
            if (id.HasValue)
            {
                LoadCarData();
                this.Text = "Редактирование автомобиля";
            }
            else
            {
                this.Text = "Новый автомобиль";
            }
        }

        private void InitializeComponent()
        {
            this.Size = new Size(500, 500);
            this.StartPosition = FormStartPosition.CenterParent;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;

            int y = 20;
            int labelWidth = 120;
            int controlWidth = 200;

            // Марка
            Label lblBrand = new Label();
            lblBrand.Text = "Марка:";
            lblBrand.Location = new Point(30, y);
            lblBrand.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblBrand);

            cmbBrand = new ComboBox();
            cmbBrand.Location = new Point(160, y);
            cmbBrand.Size = new Size(controlWidth, 23);
            cmbBrand.DropDownStyle = ComboBoxStyle.DropDownList;
            this.Controls.Add(cmbBrand);
            y += 35;

            // Модель
            Label lblModel = new Label();
            lblModel.Text = "Модель:";
            lblModel.Location = new Point(30, y);
            lblModel.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblModel);

            txtModel = new TextBox();
            txtModel.Location = new Point(160, y);
            txtModel.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtModel);
            y += 35;

            // Год
            Label lblYear = new Label();
            lblYear.Text = "Год выпуска:";
            lblYear.Location = new Point(30, y);
            lblYear.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblYear);

            numYear = new NumericUpDown();
            numYear.Location = new Point(160, y);
            numYear.Size = new Size(80, 23);
            numYear.Minimum = 2000;
            numYear.Maximum = 2030;
            numYear.Value = DateTime.Now.Year;
            this.Controls.Add(numYear);
            y += 35;

            // Цвет
            Label lblColor = new Label();
            lblColor.Text = "Цвет:";
            lblColor.Location = new Point(30, y);
            lblColor.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblColor);

            txtColor = new TextBox();
            txtColor.Location = new Point(160, y);
            txtColor.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtColor);
            y += 35;

            // VIN
            Label lblVIN = new Label();
            lblVIN.Text = "VIN код:";
            lblVIN.Location = new Point(30, y);
            lblVIN.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblVIN);

            txtVIN = new TextBox();
            txtVIN.Location = new Point(160, y);
            txtVIN.Size = new Size(controlWidth, 23);
            this.Controls.Add(txtVIN);
            y += 35;

            // Цена
            Label lblPrice = new Label();
            lblPrice.Text = "Цена (руб.):";
            lblPrice.Location = new Point(30, y);
            lblPrice.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblPrice);

            numPrice = new NumericUpDown();
            numPrice.Location = new Point(160, y);
            numPrice.Size = new Size(controlWidth, 23);
            numPrice.Minimum = 0;
            numPrice.Maximum = 100000000;
            numPrice.Value = 1000000;
            numPrice.DecimalPlaces = 2;
            this.Controls.Add(numPrice);
            y += 35;

            // В наличии
            chkInStock = new CheckBox();
            chkInStock.Text = "В наличии";
            chkInStock.Location = new Point(160, y);
            chkInStock.Size = new Size(100, 25);
            chkInStock.Checked = true;
            this.Controls.Add(chkInStock);
            y += 35;

            // Дата поступления
            Label lblArrivalDate = new Label();
            lblArrivalDate.Text = "Дата поступления:";
            lblArrivalDate.Location = new Point(30, y);
            lblArrivalDate.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblArrivalDate);

            dtpArrivalDate = new DateTimePicker();
            dtpArrivalDate.Location = new Point(160, y);
            dtpArrivalDate.Size = new Size(controlWidth, 23);
            dtpArrivalDate.Value = DateTime.Now;
            this.Controls.Add(dtpArrivalDate);
            y += 35;

            // Описание
            Label lblDescription = new Label();
            lblDescription.Text = "Описание:";
            lblDescription.Location = new Point(30, y);
            lblDescription.Size = new Size(labelWidth, 25);
            this.Controls.Add(lblDescription);

            txtDescription = new TextBox();
            txtDescription.Location = new Point(160, y);
            txtDescription.Size = new Size(controlWidth, 60);
            txtDescription.Multiline = true;
            txtDescription.ScrollBars = ScrollBars.Vertical;
            this.Controls.Add(txtDescription);
            y += 70;

            // Кнопки
            Panel buttonPanel = new Panel();
            buttonPanel.Location = new Point(30, y);
            buttonPanel.Size = new Size(430, 50);

            btnSave = new Button();
            btnSave.Text = "Сохранить";
            btnSave.Location = new Point(50, 10);
            btnSave.Size = new Size(100, 35);
            btnSave.BackColor = Color.FromArgb(46, 204, 113);
            btnSave.ForeColor = Color.White;
            btnSave.Click += BtnSave_Click;
            buttonPanel.Controls.Add(btnSave);

            btnCancel = new Button();
            btnCancel.Text = "Отмена";
            btnCancel.Location = new Point(165, 10);
            btnCancel.Size = new Size(100, 35);
            btnCancel.BackColor = Color.FromArgb(149, 165, 166);
            btnCancel.ForeColor = Color.White;
            btnCancel.Click += (s, e) => this.DialogResult = DialogResult.Cancel;
            buttonPanel.Controls.Add(btnCancel);

            if (carId.HasValue)
            {
                btnDelete = new Button();
                btnDelete.Text = "Удалить";
                btnDelete.Location = new Point(280, 10);
                btnDelete.Size = new Size(100, 35);
                btnDelete.BackColor = Color.FromArgb(231, 76, 60);
                btnDelete.ForeColor = Color.White;
                btnDelete.Click += BtnDelete_Click;
                buttonPanel.Controls.Add(btnDelete);
            }

            this.Controls.Add(buttonPanel);
        }

        private void LoadBrands()
        {
            try
            {
                string query = "SELECT BrandID, BrandName FROM Brands ORDER BY BrandName";
                DataTable dt = dbHelper.ExecuteQuery(query);
                cmbBrand.DataSource = dt;
                cmbBrand.DisplayMember = "BrandName";
                cmbBrand.ValueMember = "BrandID";
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки марок: " + ex.Message, "Ошибка");
            }
        }

        private void LoadCarData()
        {
            try
            {
                string query = @"
                    SELECT c.*, b.BrandName 
                    FROM Cars c 
                    JOIN Brands b ON c.BrandID = b.BrandID 
                    WHERE c.CarID = @CarID";
                
                DataTable dt = dbHelper.ExecuteQuery(query, 
                    new MySqlParameter("@CarID", carId.Value));
                
                if (dt.Rows.Count > 0)
                {
                    DataRow row = dt.Rows[0];
                    
                    // Выбираем марку в ComboBox
                    for (int i = 0; i < cmbBrand.Items.Count; i++)
                    {
                        DataRowView item = cmbBrand.Items[i] as DataRowView;
                        if (item != null && Convert.ToInt32(item["BrandID"]) == Convert.ToInt32(row["BrandID"]))
                        {
                            cmbBrand.SelectedIndex = i;
                            break;
                        }
                    }
                    
                    txtModel.Text = row["Model"].ToString();
                    numYear.Value = Convert.ToInt32(row["Year"]);
                    txtColor.Text = row["Color"].ToString();
                    txtVIN.Text = row["VIN"].ToString();
                    numPrice.Value = Convert.ToDecimal(row["Price"]);
                    chkInStock.Checked = Convert.ToBoolean(row["InStock"]);
                    
                    if (row["ArrivalDate"] != DBNull.Value)
                    {
                        dtpArrivalDate.Value = Convert.ToDateTime(row["ArrivalDate"]);
                    }
                    
                    if (row["Description"] != DBNull.Value)
                    {
                        txtDescription.Text = row["Description"].ToString();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка загрузки данных автомобиля: " + ex.Message, "Ошибка");
            }
        }

        private void BtnSave_Click(object sender, EventArgs e)
        {
            if (cmbBrand.SelectedIndex == -1)
            {
                MessageBox.Show("Выберите марку автомобиля", "Ошибка");
                return;
            }

            if (string.IsNullOrWhiteSpace(txtModel.Text))
            {
                MessageBox.Show("Введите модель автомобиля", "Ошибка");
                return;
            }

            if (string.IsNullOrWhiteSpace(txtVIN.Text))
            {
                MessageBox.Show("Введите VIN код автомобиля", "Ошибка");
                return;
            }

            try
            {
                if (carId.HasValue)
                {
                    // Обновление существующего автомобиля
                    string query = @"
                        UPDATE Cars 
                        SET BrandID = @BrandID,
                            Model = @Model,
                            Year = @Year,
                            Color = @Color,
                            VIN = @VIN,
                            Price = @Price,
                            InStock = @InStock,
                            ArrivalDate = @ArrivalDate,
                            Description = @Description
                        WHERE CarID = @CarID";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@BrandID", cmbBrand.SelectedValue),
                        new MySqlParameter("@Model", txtModel.Text),
                        new MySqlParameter("@Year", (int)numYear.Value),
                        new MySqlParameter("@Color", txtColor.Text),
                        new MySqlParameter("@VIN", txtVIN.Text),
                        new MySqlParameter("@Price", numPrice.Value),
                        new MySqlParameter("@InStock", chkInStock.Checked),
                        new MySqlParameter("@ArrivalDate", dtpArrivalDate.Value),
                        new MySqlParameter("@Description", txtDescription.Text),
                        new MySqlParameter("@CarID", carId.Value)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                else
                {
                    // Добавление нового автомобиля
                    string query = @"
                        INSERT INTO Cars (BrandID, Model, Year, Color, VIN, Price, InStock, ArrivalDate, Description)
                        VALUES (@BrandID, @Model, @Year, @Color, @VIN, @Price, @InStock, @ArrivalDate, @Description)";
                    
                    MySqlParameter[] parameters = {
                        new MySqlParameter("@BrandID", cmbBrand.SelectedValue),
                        new MySqlParameter("@Model", txtModel.Text),
                        new MySqlParameter("@Year", (int)numYear.Value),
                        new MySqlParameter("@Color", txtColor.Text),
                        new MySqlParameter("@VIN", txtVIN.Text),
                        new MySqlParameter("@Price", numPrice.Value),
                        new MySqlParameter("@InStock", chkInStock.Checked),
                        new MySqlParameter("@ArrivalDate", dtpArrivalDate.Value),
                        new MySqlParameter("@Description", txtDescription.Text)
                    };
                    
                    dbHelper.ExecuteNonQuery(query, parameters);
                }
                
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            catch (MySqlException ex) when (ex.Number == 1062)
            {
                MessageBox.Show("Автомобиль с таким VIN кодом уже существует", "Ошибка");
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка сохранения автомобиля: " + ex.Message, "Ошибка");
            }
        }

        private void BtnDelete_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Вы уверены, что хотите удалить этот автомобиль?", 
                "Подтверждение удаления", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
            {
                try
                {
                    string query = "DELETE FROM Cars WHERE CarID = @CarID";
                    dbHelper.ExecuteNonQuery(query, new MySqlParameter("@CarID", carId.Value));
                    
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Ошибка удаления автомобиля: " + ex.Message, "Ошибка");
                }
            }
        }
    }
}